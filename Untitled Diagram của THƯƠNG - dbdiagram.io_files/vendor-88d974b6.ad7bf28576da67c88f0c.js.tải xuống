!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=(new Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="12240b8d-883f-43d4-88b8-153330308aa4",e._sentryDebugIdIdentifier="sentry-dbid-12240b8d-883f-43d4-88b8-153330308aa4")}catch(e){}}();var _global="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};_global.SENTRY_RELEASE={id:"13ad4a0c312011ebb49f3e8dc8f97be809f60d04"},(self.webpackChunkschema_diagram_vue=self.webpackChunkschema_diagram_vue||[]).push([[958],{72212:function(e,t,n){Object.defineProperty(t,Symbol.toStringTag,{value:"Module"});const i=n(2543);var s,a=((s=a||{}).SPACE="<space>",s.TAB="<tab>",s.NEWLINE="<newline>",s.COMMA="<comma>",s.LPAREN="<lparen>",s.RPAREN="<rparen>",s.LBRACE="<lbrace>",s.RBRACE="<rbrace>",s.LBRACKET="<lbracket>",s.RBRACKET="<rbracket>",s.LANGLE="<langle>",s.RANGLE="<rangle>",s.OP="<op>",s.EOF="<eof>",s.NUMERIC_LITERAL="<number>",s.STRING_LITERAL="<string>",s.COLOR_LITERAL="<color>",s.FUNCTION_EXPRESSION="<function-expression>",s.QUOTED_STRING="<variable>",s.IDENTIFIER="<identifier>",s.SEMICOLON="<semicolon>",s.COLON="<colon>",s.TILDE="<tilde>",s.SINGLE_LINE_COMMENT="<single-line-comment>",s.MULTILINE_COMMENT="<multiline-comment>",s);function r(e){switch(e.kind){case"<newline>":case"<space>":case"<tab>":case"<single-line-comment>":case"<multiline-comment>":return!0;default:return!1}}function o(e){if(!e)return!1;switch(e){case"+":case"-":case"*":case"/":case"%":case"<":case">":case"=":case"!":case".":case"&":case"|":return!0;default:return!1}}function l(e){return void 0!==e&&"<op>"===e.kind}class c{constructor(e,t,n,i,s){this.kind=e,this.startPos=t,this.endPos=n,this.value=i,this.leadingTrivia=[],this.trailingTrivia=[],this.leadingInvalid=[],this.trailingInvalid=[],this.isInvalid=s,this.start=t.offset,this.end=n.offset}static create(e,t,n,i,s){return new c(e,t,n,i,s)}}function u(e){return void 0!==e.trailingTrivia.find((({kind:e})=>e===a.NEWLINE))}function h(e,t){return void 0!==t.leadingTrivia.find((({kind:e})=>e===a.NEWLINE))||u(e)}function d(e){return void 0!==e.trailingTrivia.find((({kind:e})=>[a.SPACE,a.TAB].includes(e)))}function p(e){return 0===e.trailingTrivia.length?e.end:p(i.last(e.trailingTrivia))}function E(e){return 0===e.leadingTrivia.length?e.start:E(e.leadingTrivia[0])}class N{constructor(){this.id=0}reset(){this.id=0}nextId(){return this.id++}}class f{constructor(e,t,n){this.id=e,this.kind=t;const i=n.find((e=>void 0!==e&&!Number.isNaN(e.start)));i?(this.startPos=i.startPos,this.fullStart=i instanceof c?E(i):i.fullStart):(this.startPos={offset:NaN,column:NaN,line:NaN},this.fullStart=NaN);const s=[...n].reverse().find((e=>void 0!==e&&!Number.isNaN(e.end)));s?(this.endPos=s.endPos,this.fullEnd=s instanceof c?p(s):s.fullEnd):(this.endPos={offset:NaN,column:NaN,line:NaN},this.fullEnd=NaN),this.start=this.startPos.offset,this.end=this.endPos.offset}}var m=(e=>(e.PROGRAM="<program>",e.ELEMENT_DECLARATION="<element-declaration>",e.ATTRIBUTE="<attribute>",e.IDENTIFIER_STREAM="<identifer-stream>",e.LITERAL="<literal>",e.VARIABLE="<variable>",e.PREFIX_EXPRESSION="<prefix-expression>",e.INFIX_EXPRESSION="<infix-expression>",e.POSTFIX_EXPRESSION="<postfix-expression>",e.FUNCTION_EXPRESSION="<function-expression>",e.FUNCTION_APPLICATION="<function-application>",e.BLOCK_EXPRESSION="<block-expression>",e.LIST_EXPRESSION="<list-expression>",e.TUPLE_EXPRESSION="<tuple-expression>",e.CALL_EXPRESSION="<call-expression>",e.PRIMARY_EXPRESSION="<primary-expression>",e.GROUP_EXPRESSION="<group-expression>",e.DUMMY="<dummy>",e.ARRAY="<array>",e.PARTIAL_INJECTION="<partial-injection>",e))(m||{});class T extends f{constructor({body:e=[],eof:t},n){super(n,"<program>",[...e,t]),this.body=e,this.eof=t}}class b extends f{constructor({type:e,name:t,as:n,alias:i,attributeList:s,bodyColon:a,body:r},o){if(super(o,"<element-declaration>",[e,t,n,i,s,a,r]),r&&a&&!(r instanceof g||r instanceof b))throw new Error("If an element has a simple body, it must be a function application node");this.type=e,this.name=t,this.as=n,this.alias=i,this.attributeList=s,this.bodyColon=a,this.body=r}}class I extends f{constructor({identifiers:e=[]},t){super(t,"<identifer-stream>",e||[]),this.identifiers=e}}class v extends f{constructor({name:e,colon:t,value:n},i){super(i,"<attribute>",[e,t,n]),this.name=e,this.value=n,this.colon=t}}class L extends f{constructor({op:e,expression:t},n){super(n,"<prefix-expression>",[e,t]),this.op=e,this.expression=t}}class _ extends f{constructor({op:e,leftExpression:t,rightExpression:n},i){super(i,"<infix-expression>",[t,e,n]),this.op=e,this.leftExpression=t,this.rightExpression=n}}class A extends f{constructor({op:e,expression:t},n){super(n,"<postfix-expression>",[t,e]),this.op=e,this.expression=t}}class y extends f{constructor({value:e},t){super(t,"<function-expression>",[e]),this.value=e}}class g extends f{constructor({callee:e,args:t=[]},n){super(n,"<function-application>",[e,...t]),this.callee=e,this.args=t}}class w extends f{constructor({blockOpenBrace:e,body:t=[],blockCloseBrace:n},i){super(i,"<block-expression>",[e,...t,n]),this.blockOpenBrace=e,this.body=t,this.blockCloseBrace=n}}class C extends f{constructor({op:e,partial:t},n){super(n,"<partial-injection>",[e,t]),this.partial=t}}class k extends f{constructor({listOpenBracket:e,elementList:t=[],commaList:n=[],listCloseBracket:i},s){super(s,"<list-expression>",[e,...F(t,n),i]),this.listOpenBracket=e,this.elementList=t,this.commaList=n,this.listCloseBracket=i}}class S extends f{constructor({tupleOpenParen:e,elementList:t=[],commaList:n=[],tupleCloseParen:i},s){super(s,"<tuple-expression>",[e,...F(t,n),i]),this.tupleOpenParen=e,this.elementList=t,this.commaList=n,this.tupleCloseParen=i}}class P extends S{constructor({groupOpenParen:e,expression:t,groupCloseParen:n},i){super({tupleOpenParen:e,elementList:t&&[t],commaList:[],tupleCloseParen:n},i),this.kind="<group-expression>"}}class D extends f{constructor({callee:e,argumentList:t},n){super(n,"<call-expression>",[e,t]),this.callee=e,this.argumentList=t}}class O extends f{constructor({literal:e},t){super(t,"<literal>",[e]),this.literal=e}}class x extends f{constructor({variable:e},t){super(t,"<variable>",[e]),this.variable=e}}class R extends f{constructor({expression:e},t){super(t,"<primary-expression>",[e]),this.expression=e}}class U extends f{constructor({pre:e},t){super(t,"<dummy>",[c.create(a.SPACE,e.endPos,e.endPos," ",!1)])}}class M extends f{constructor({expression:e,indexer:t},n){super(n,"<array>",[e,t]),this.array=e,this.indexer=t}}function F(e,t){if(!e||0===e.length)return t||[];if(!t||0===t.length)return e||[];const[n]=e,[s]=t;return(n.start<s.start?i.flatten(i.zip(e,t)):i.flatten(i.zip(t,e))).filter((e=>null!==e))}class B{constructor(e){this.value=e}unwrap(){return this.value}unwrap_or(e){return this.value}and_then(e){return e(this.value)}map(e){return new B(e(this.value))}isOk(){return!0}}class V{constructor(){this.value=void 0}unwrap(){throw new Error("Trying to unwrap a None value")}unwrap_or(e){return e}and_then(e){return new V}map(e){return new V}isOk(){return!1}}var G=(e=>(e.Schema="Schema",e.Table="Table",e.Column="Column",e.TableGroup="TableGroup",e.TableGroupField="TableGroup field",e.Enum="Enum",e.EnumField="Enum field",e.Note="Note",e.TablePartial="TablePartial",e.TablePartialInjection="TablePartialInjection",e))(G||{});function X(e){return`Schema:${e}`}function K(e){return`Table:${e}`}function $(e){return`Column:${e}`}function j(e){return`Enum:${e}`}function W(e){return`Enum field:${e}`}function q(e){return`TableGroup:${e}`}function Y(e){return`TableGroup field:${e}`}function H(e){return`TablePartial:${e}`}function z(e){return`TablePartialInjection:${e}`}function Q(e,t){switch(t){case"Column":return $(e);case"Enum":return j(e);case"Enum field":return W(e);case"Schema":return X(e);case"Table":return K(e);case"TableGroup":return q(e);case"TableGroup field":return Y(e);case"TablePartial":return H(e);default:throw new Error("Unreachable")}}function J(e){const[t,n]=e.split(":");return Object.values(G).includes(t)?new B({name:n,kind:t}):new V}class Z{constructor(){this.id=0}reset(){this.id=0}nextId(){return this.id++}}class ee{constructor({symbolTable:e},t){this.references=[],this.id=t,this.symbolTable=e}}class te{constructor({symbolTable:e,declaration:t},n){this.references=[],this.id=n,this.symbolTable=e,this.declaration=t}}class ne{constructor({declaration:e},t){this.references=[],this.id=t,this.declaration=e}}class ie{constructor({symbolTable:e,declaration:t},n){this.references=[],this.id=n,this.symbolTable=e,this.declaration=t}}class se{constructor({declaration:e},t){this.references=[],this.id=t,this.declaration=e}}class ae{constructor({symbolTable:e,declaration:t},n){this.references=[],this.id=n,this.symbolTable=e,this.declaration=t}}class re{constructor({declaration:e},t){this.references=[],this.id=t,this.declaration=e}}class oe{constructor({symbolTable:e,declaration:t},n){this.references=[],this.id=n,this.symbolTable=e,this.declaration=t}}class le{constructor({declaration:e},t){this.references=[],this.id=t,this.declaration=e}}class ce{constructor({injectorFieldSymbol:e,injectorDeclaration:t},n){this.references=[],this.id=n,this.injectorDeclaration=t,this.injectorFieldSymbol=e}}function ue(e){return[X,K,j,q,$,W,Y,H,z].map((t=>t(e)))}function he(e){return!!e.match(/(\p{L}|_|\p{M})/gu)}function de(e){const[t]=e;return t>="0"&&t<="9"}function pe(e){const[t]=e;return de(t)||he(t)&&t.toLowerCase()>="a"&&t.toLowerCase()<="f"}function Ee(e){return he(e)||de(e)}function Ne(e,t){const n=[],i=Math.min(e.length,t.length);for(let s=0;s<i;s+=1)n.push(e[s],t[s]);return n.push(...e.slice(i),...t.slice(i)),n}function fe(e,t){return e>=t.start&&e<t.end}function me(e){var t;return e instanceof L?`${null==(t=e.op)?void 0:t.value}${me(e.expression)}`:e.expression.literal.value}function Te(e){var t;return e instanceof L?"-"===(null==(t=e.op)?void 0:t.value)?-Te(e.expression):Te(e.expression):Number.parseFloat(e.expression.literal.value)}var be=(e=>(e[e.UNKNOWN_SYMBOL=1e3]="UNKNOWN_SYMBOL",e[e.UNEXPECTED_SYMBOL=1001]="UNEXPECTED_SYMBOL",e[e.UNEXPECTED_EOF=1002]="UNEXPECTED_EOF",e[e.UNEXPECTED_NEWLINE=1003]="UNEXPECTED_NEWLINE",e[e.UNKNOWN_TOKEN=1004]="UNKNOWN_TOKEN",e[e.UNEXPECTED_TOKEN=1005]="UNEXPECTED_TOKEN",e[e.UNEXPECTED_ELEMENT_DECLARATION=1006]="UNEXPECTED_ELEMENT_DECLARATION",e[e.MISSING_SPACES=1007]="MISSING_SPACES",e[e.UNKNOWN_PREFIX_OP=1008]="UNKNOWN_PREFIX_OP",e[e.INVALID_OPERAND=1009]="INVALID_OPERAND",e[e.EMPTY_ATTRIBUTE_NAME=1010]="EMPTY_ATTRIBUTE_NAME",e[e.INVALID_ESCAPE_SEQUENCE=1011]="INVALID_ESCAPE_SEQUENCE",e[e.INVALID_NAME=3e3]="INVALID_NAME",e[e.UNEXPECTED_NAME=3001]="UNEXPECTED_NAME",e[e.NAME_NOT_FOUND=3002]="NAME_NOT_FOUND",e[e.DUPLICATE_NAME=3003]="DUPLICATE_NAME",e[e.INVALID_ALIAS=3004]="INVALID_ALIAS",e[e.UNEXPECTED_ALIAS=3005]="UNEXPECTED_ALIAS",e[e.UNEXPECTED_SETTINGS=3006]="UNEXPECTED_SETTINGS",e[e.INVALID_SETTINGS=3007]="INVALID_SETTINGS",e[e.UNEXPECTED_SIMPLE_BODY=3008]="UNEXPECTED_SIMPLE_BODY",e[e.UNEXPECTED_COMPLEX_BODY=3009]="UNEXPECTED_COMPLEX_BODY",e[e.INVALID_TABLE_CONTEXT=3010]="INVALID_TABLE_CONTEXT",e[e.INVALID_TABLE_SETTING=3011]="INVALID_TABLE_SETTING",e[e.DUPLICATE_TABLE_SETTING=3012]="DUPLICATE_TABLE_SETTING",e[e.INVALID_TABLEGROUP_CONTEXT=3013]="INVALID_TABLEGROUP_CONTEXT",e[e.INVALID_TABLEGROUP_ELEMENT_NAME=3014]="INVALID_TABLEGROUP_ELEMENT_NAME",e[e.DUPLICATE_TABLEGROUP_ELEMENT_NAME=3015]="DUPLICATE_TABLEGROUP_ELEMENT_NAME",e[e.DUPLICATE_TABLEGROUP_FIELD_NAME=3016]="DUPLICATE_TABLEGROUP_FIELD_NAME",e[e.INVALID_TABLEGROUP_FIELD=3017]="INVALID_TABLEGROUP_FIELD",e[e.EMPTY_TABLE=3018]="EMPTY_TABLE",e[e.INVALID_COLUMN=3019]="INVALID_COLUMN",e[e.INVALID_COLUMN_NAME=3020]="INVALID_COLUMN_NAME",e[e.UNKNOWN_COLUMN_SETTING=3021]="UNKNOWN_COLUMN_SETTING",e[e.INVALID_COLUMN_TYPE=3022]="INVALID_COLUMN_TYPE",e[e.DUPLICATE_COLUMN_NAME=3023]="DUPLICATE_COLUMN_NAME",e[e.DUPLICATE_COLUMN_SETTING=3024]="DUPLICATE_COLUMN_SETTING",e[e.INVALID_COLUMN_SETTING_VALUE=3025]="INVALID_COLUMN_SETTING_VALUE",e[e.INVALID_ENUM_CONTEXT=3026]="INVALID_ENUM_CONTEXT",e[e.INVALID_ENUM_ELEMENT_NAME=3027]="INVALID_ENUM_ELEMENT_NAME",e[e.INVALID_ENUM_ELEMENT=3028]="INVALID_ENUM_ELEMENT",e[e.DUPLICATE_ENUM_ELEMENT_NAME=3029]="DUPLICATE_ENUM_ELEMENT_NAME",e[e.UNKNOWN_ENUM_ELEMENT_SETTING=3030]="UNKNOWN_ENUM_ELEMENT_SETTING",e[e.DUPLICATE_ENUM_ELEMENT_SETTING=3031]="DUPLICATE_ENUM_ELEMENT_SETTING",e[e.INVALID_ENUM_ELEMENT_SETTING=3032]="INVALID_ENUM_ELEMENT_SETTING",e[e.EMPTY_ENUM=3033]="EMPTY_ENUM",e[e.INVALID_REF_CONTEXT=3034]="INVALID_REF_CONTEXT",e[e.UNKNOWN_REF_SETTING=3035]="UNKNOWN_REF_SETTING",e[e.DUPLICATE_REF_SETTING=3036]="DUPLICATE_REF_SETTING",e[e.INVALID_REF_SETTING_VALUE=3037]="INVALID_REF_SETTING_VALUE",e[e.INVALID_REF_RELATIONSHIP=3038]="INVALID_REF_RELATIONSHIP",e[e.INVALID_REF_FIELD=3039]="INVALID_REF_FIELD",e[e.EMPTY_REF=3040]="EMPTY_REF",e[e.REF_REDEFINED=3041]="REF_REDEFINED",e[e.INVALID_NOTE_CONTEXT=3042]="INVALID_NOTE_CONTEXT",e[e.INVALID_NOTE=3043]="INVALID_NOTE",e[e.NOTE_REDEFINED=3044]="NOTE_REDEFINED",e[e.NOTE_CONTENT_REDEFINED=3045]="NOTE_CONTENT_REDEFINED",e[e.EMPTY_NOTE=3046]="EMPTY_NOTE",e[e.INVALID_INDEXES_CONTEXT=3047]="INVALID_INDEXES_CONTEXT",e[e.INVALID_INDEXES_FIELD=3048]="INVALID_INDEXES_FIELD",e[e.INVALID_INDEX=3049]="INVALID_INDEX",e[e.UNKNOWN_INDEX_SETTING=3050]="UNKNOWN_INDEX_SETTING",e[e.DUPLICATE_INDEX_SETTING=3051]="DUPLICATE_INDEX_SETTING",e[e.UNEXPECTED_INDEX_SETTING_VALUE=3052]="UNEXPECTED_INDEX_SETTING_VALUE",e[e.INVALID_INDEX_SETTING_VALUE=3053]="INVALID_INDEX_SETTING_VALUE",e[e.INVALID_PROJECT_CONTEXT=3054]="INVALID_PROJECT_CONTEXT",e[e.PROJECT_REDEFINED=3055]="PROJECT_REDEFINED",e[e.INVALID_PROJECT_FIELD=3056]="INVALID_PROJECT_FIELD",e[e.INVALID_CUSTOM_CONTEXT=3057]="INVALID_CUSTOM_CONTEXT",e[e.INVALID_CUSTOM_ELEMENT_VALUE=3058]="INVALID_CUSTOM_ELEMENT_VALUE",e[e.INVALID_ELEMENT_IN_SIMPLE_BODY=3059]="INVALID_ELEMENT_IN_SIMPLE_BODY",e[e.INVALID_TABLE_PARTIAL_CONTEXT=3060]="INVALID_TABLE_PARTIAL_CONTEXT",e[e.INVALID_TABLE_PARTIAL_ELEMENT_NAME=3061]="INVALID_TABLE_PARTIAL_ELEMENT_NAME",e[e.INVALID_TABLE_PARTIAL_SETTING=3062]="INVALID_TABLE_PARTIAL_SETTING",e[e.DUPLICATE_TABLE_PARTIAL_ELEMENT_NAME=3063]="DUPLICATE_TABLE_PARTIAL_ELEMENT_NAME",e[e.DUPLICATE_TABLE_PARTIAL_SETTING=3064]="DUPLICATE_TABLE_PARTIAL_SETTING",e[e.INVALID_TABLE_PARTIAL_INJECTION=3065]="INVALID_TABLE_PARTIAL_INJECTION",e[e.INVALID_TABLE_PARTIAL_INJECTION_OP=3066]="INVALID_TABLE_PARTIAL_INJECTION_OP",e[e.INVALID_TABLE_PARTIAL_INJECTION_NAME=3067]="INVALID_TABLE_PARTIAL_INJECTION_NAME",e[e.DUPLICATE_TABLE_PARTIAL_INJECTION_NAME=3068]="DUPLICATE_TABLE_PARTIAL_INJECTION_NAME",e[e.BINDING_ERROR=4e3]="BINDING_ERROR",e[e.UNSUPPORTED=5e3]="UNSUPPORTED",e[e.CIRCULAR_REF=5001]="CIRCULAR_REF",e[e.SAME_ENDPOINT=5002]="SAME_ENDPOINT",e[e.UNEQUAL_FIELDS_BINARY_REF=5003]="UNEQUAL_FIELDS_BINARY_REF",e[e.CONFLICTING_SETTING=5004]="CONFLICTING_SETTING",e[e.TABLE_REAPPEAR_IN_TABLEGROUP=5005]="TABLE_REAPPEAR_IN_TABLEGROUP",e))(be||{});class Ie extends Error{constructor(e,t,n){super(t),this.code=e,this.diagnostic=t,this.nodeOrToken=n,this.start=n.start,this.end=n.end,this.name=this.constructor.name,Object.setPrototypeOf(this,Ie.prototype)}}class ve{constructor(e,t){this.value=e,this.errors=void 0===t?[]:t}getValue(){return this.value}getErrors(){return this.errors}chain(e){const t=e(this.value),n=[...this.errors,...t.errors];return new ve(t.value,n)}map(e){return new ve(e(this.value),this.errors)}}function Le(e){return e.kind===a.IDENTIFIER&&"as"===e.value}function _e(e){e&&(e instanceof c?function(e){e.kind!==a.EOF&&(e.isInvalid=!0)}(e):function(e){if(e instanceof b)_e(e.type),_e(e.name),_e(e.as),_e(e.alias),_e(e.bodyColon),_e(e.attributeList),_e(e.body);else if(e instanceof I)e.identifiers.forEach(_e);else if(e instanceof v)_e(e.name),_e(e.colon),_e(e.value);else if(e instanceof L)_e(e.op),_e(e.expression);else if(e instanceof _)_e(e.leftExpression),_e(e.op),_e(e.rightExpression);else if(e instanceof A)_e(e.op),_e(e.expression);else if(e instanceof w)_e(e.blockOpenBrace),e.body.forEach(_e),_e(e.blockCloseBrace);else if(e instanceof k)_e(e.listOpenBracket),e.commaList.forEach(_e),e.elementList.forEach(_e),_e(e.listCloseBracket);else if(e instanceof S)_e(e.tupleOpenParen),e.commaList.forEach(_e),e.elementList.forEach(_e),_e(e.tupleCloseParen);else if(e instanceof D)_e(e.callee),_e(e.argumentList);else if(e instanceof g)_e(e.callee),e.args.forEach(_e);else if(e instanceof R)_e(e.expression);else if(e instanceof y)_e(e.value);else if(e instanceof x)_e(e.variable);else{if(!(e instanceof O))throw e instanceof P?new Error("This case is handled by the TupleExpressionNode case"):new Error("Unreachable case in markInvalidNode");_e(e.literal)}}(e))}function Ae(e){return!(null==e||!e.isInvalid)}function ye(...e){return e.filter((e=>void 0!==e))}function ge(e){if(e instanceof T)return ye(...e.body,e.eof);if(e instanceof b)return ye(e.type,e.name,e.as,e.alias,e.attributeList,e.bodyColon,e.body);if(e instanceof v)return ye(e.name,e.colon,e.value);if(e instanceof I)return e.identifiers;if(e instanceof O)return e.literal?[e.literal]:[];if(e instanceof x)return ye(e.variable);if(e instanceof L)return ye(e.op,e.expression);if(e instanceof _)return ye(e.leftExpression,e.op,e.rightExpression);if(e instanceof A)return ye(e.expression,e.op);if(e instanceof y)return ye(e.value);if(e instanceof g)return ye(e.callee,...e.args);if(e instanceof w)return ye(e.blockOpenBrace,...e.body,e.blockCloseBrace);if(e instanceof k)return ye(e.listOpenBracket,...Ne(e.elementList,e.commaList),e.listCloseBracket);if(e instanceof S)return ye(e.tupleOpenParen,...Ne(e.elementList,e.commaList),e.tupleCloseParen);if(e instanceof D)return ye(e.callee,e.argumentList);if(e instanceof R)return ye(e.expression);if(e instanceof M)return ye(e.array,e.indexer);if(e instanceof C)return ye(e.partial);throw e instanceof P?new Error("This case is already handled by TupleExpressionNode"):new Error("Unreachable - no other possible cases")}function we(e){return ke(e)?new B(e.expression.variable):new V}function Ce(e){var t;return e instanceof R&&(e.expression instanceof x&&e.expression.variable instanceof c&&e.expression.variable.kind===a.QUOTED_STRING||e.expression instanceof O&&(null==(t=e.expression.literal)?void 0:t.kind)===a.STRING_LITERAL)}function ke(e){return e instanceof R&&e.expression instanceof x&&e.expression.variable instanceof c}function Se(e){var t;return e instanceof R&&e.expression instanceof x&&(null==(t=e.expression.variable)?void 0:t.kind)===a.IDENTIFIER}function Pe(e){var t;return e instanceof _&&e.leftExpression instanceof f&&e.rightExpression instanceof f&&"."===(null==(t=e.op)?void 0:t.value)}function De(e){if(void 0===e)return new V;const t=e.identifiers.map((e=>e.value)).join(" ");return""===t?new V:new B(t)}class Oe{constructor(e){this.start={offset:0,line:0,column:0},this.current={offset:0,line:0,column:0},this.tokens=[],this.errors=[],this.text=e}isAtEnd(){return this.current.offset>=this.text.length}advance(){const e=this.peek();return this.current={...this.current},"\n"===e?(this.current.line+=1,this.current.column=0):this.current.column+=1,this.current.offset+=1,e}peek(e=0){if(!(this.current.offset+e>=this.text.length))return this.text[this.current.offset+e]}check(e){for(let t=0;t<e.length;t+=1)if(e[t]!==this.peek(t))return!1;return!0}match(e){return!!this.check(e)&&(e.split("").forEach((()=>this.advance())),!0)}addToken(e,t=!1){this.tokens.push(this.createToken(e,t))}createToken(e,t=!1){return c.create(e,this.start,this.current,this.text.substring(this.start.offset,this.current.offset),t)}lex(){return this.scanTokens(),this.tokens.push(c.create(a.EOF,this.start,this.current,"",!1)),this.gatherTrivia(),this.gatherInvalid(),new ve(this.tokens,this.errors)}scanTokens(){for(;!this.isAtEnd();){const e=this.advance();switch(e){case" ":this.addToken(a.SPACE);break;case"\r":break;case"\n":this.addToken(a.NEWLINE);break;case"\t":this.addToken(a.TAB);break;case",":this.addToken(a.COMMA);break;case"(":this.addToken(a.LPAREN);break;case")":this.addToken(a.RPAREN);break;case"[":this.addToken(a.LBRACKET);break;case"]":this.addToken(a.RBRACKET);break;case"{":this.addToken(a.LBRACE);break;case"}":this.addToken(a.RBRACE);break;case";":this.addToken(a.SEMICOLON);break;case":":this.addToken(a.COLON);break;case"~":this.addToken(a.TILDE);break;case"'":this.match("''")?this.multilineStringLiteral():this.singleLineStringLiteral();break;case'"':this.quotedVariable();break;case"`":this.functionExpression();break;case"#":this.colorLiteral();break;case"/":this.match("/")?this.singleLineComment():this.match("*")?this.multilineComment():this.operator(e);break;default:if(o(e)){this.operator(e);break}if(he(e)){this.identifier();break}if(de(e)){this.numericLiteralOrIdentifier();break}this.addToken(a.OP,!0),this.errors.push(new Ie(be.UNKNOWN_SYMBOL,`Unexpected token '${e}'`,this.createToken(a.OP,!0)))}this.start={...this.current}}}gatherTrivia(){let e,t=!0,n=[];const i=[];for(const s of this.tokens)r(s)?(n.push(s),s.kind===a.NEWLINE&&e&&(e.trailingTrivia=n,t=!0,e=void 0,n=[])):(t?s.leadingTrivia=n:e.trailingTrivia=n,i.push(s),n=[],e=s,t=!1);this.tokens=i}gatherInvalid(){let e;const t=[],n=[];for(e=0;e<this.tokens.length&&Ae(this.tokens[e]);e+=1)n.push(this.tokens[e]);let i=this.tokens[e];for(i.leadingInvalid=[...n,...i.leadingInvalid];e<this.tokens.length;e+=1){const n=this.tokens[e];n.isInvalid?i.trailingInvalid.push(n):(i=n,t.push(n))}this.tokens=t}consumeUntil(e,t,{allowNewline:n,allowEof:i,raw:s,consumeStopSequence:a=!0}){let r="";for(;!this.isAtEnd()&&(n||!this.check("\n"))&&!this.check(t);)"\\"!==this.peek()||s?r+=this.advance():(this.advance(),r+=this.escapedString());if(this.isAtEnd()&&!i){const t=this.createToken(e,!0);return this.tokens.push(t),void this.errors.push(new Ie(be.UNEXPECTED_EOF,"EOF reached while parsing",t))}if(this.check("\n")&&!n){const t=this.createToken(e,!0);return this.tokens.push(t),void this.errors.push(new Ie(be.UNEXPECTED_NEWLINE,"Invalid newline encountered while parsing",t))}a&&this.match(t),this.tokens.push(c.create(e,this.start,this.current,r,!1))}singleLineStringLiteral(){this.consumeUntil(a.STRING_LITERAL,"'",{allowNewline:!1,allowEof:!1,raw:!1})}multilineStringLiteral(){this.consumeUntil(a.STRING_LITERAL,"'''",{allowNewline:!0,allowEof:!1,raw:!1})}functionExpression(){this.consumeUntil(a.FUNCTION_EXPRESSION,"`",{allowNewline:!1,allowEof:!1,raw:!0})}quotedVariable(){this.consumeUntil(a.QUOTED_STRING,'"',{allowNewline:!1,allowEof:!1,raw:!1})}singleLineComment(){this.consumeUntil(a.SINGLE_LINE_COMMENT,"\n",{allowNewline:!0,allowEof:!0,raw:!0,consumeStopSequence:!1})}multilineComment(){this.consumeUntil(a.MULTILINE_COMMENT,"*/",{allowNewline:!0,allowEof:!1,raw:!0})}identifier(){for(;!this.isAtEnd()&&Ee(this.peek());)this.advance();this.addToken(a.IDENTIFIER)}operator(e){switch(e){case"<":[">","="].includes(this.peek())&&this.advance();break;case">":case"=":case"!":"="===this.peek()&&this.advance()}this.addToken(a.OP)}numericLiteralOrIdentifier(){let e=0;if(this.isAtEnd())return this.addToken(a.NUMERIC_LITERAL);for(;!this.isAtEnd();){const t=this.check(".");if(e+=t?1:0,e>1)break;if(!t&&this.current.offset===this.text.length-1)return this.advance(),this.addToken(a.NUMERIC_LITERAL);if(!t&&!Ee(this.peek()))return this.addToken(a.NUMERIC_LITERAL);if(!t&&!de(this.peek()))break;this.advance()}if(e>0){for(;!this.isAtEnd()&&(this.check(".")||Ee(this.peek()));)this.advance();const e=this.createToken(a.NUMERIC_LITERAL,!0);this.tokens.push(e),this.errors.push(new Ie(be.UNKNOWN_TOKEN,"Invalid number",e))}else{for(;!this.isAtEnd()&&Ee(this.peek());)this.advance();const e=this.createToken(a.IDENTIFIER,!1);this.tokens.push(e)}}colorLiteral(){for(;!this.isAtEnd()&&Ee(this.peek());)this.advance();this.addToken(a.COLOR_LITERAL)}escapedString(){const e={column:this.current.column-1,offset:this.current.offset-1,line:this.current.line};if(this.isAtEnd())return"\\";switch(this.advance()){case"\r":return this.check("\n")&&this.advance(),"";case"\n":return"";case"t":return"\t";case"n":return"\n";case"\\":return"\\";case"r":return"\r";case"'":return"'";case'"':return'"';case"0":return"\0";case"b":return"\b";case"v":return"\v";case"f":return"\f";case" ":return"\\ ";case"u":{let t="";for(let n=0;n<=3;n+=1){if(this.isAtEnd()||!Ee(this.peek()))return this.errors.push(new Ie(be.INVALID_ESCAPE_SEQUENCE,`Invalid unicode escape sequence '\\u${t}', only unicode escape sequences of the form '\\uHHHH' where H is a hexadecimal number are allowed`,c.create(a.STRING_LITERAL,e,this.current,`\\u${t}`,!0))),`\\u${t}`;t+=this.advance()}return String.fromCharCode(parseInt(t,16))}default:return this.text[this.current.offset-1]}}}var xe=(e=>(e[e.ListExpression=0]="ListExpression",e[e.GroupExpression=1]="GroupExpression",e[e.BlockExpression=2]="BlockExpression",e))(xe||{});class Re{constructor(){this.stack=[],this.numberOfNestedLParens=0,this.numberOfNestedLBrackets=0,this.numberOfNestedLBraces=0}push(e){this.stack.push(e),0===e&&(this.numberOfNestedLBrackets+=1),1===e&&(this.numberOfNestedLParens+=1),2===e&&(this.numberOfNestedLBraces+=1)}pop(){const e=this.stack.pop();return 0===e&&(this.numberOfNestedLBrackets-=1),1===e&&(this.numberOfNestedLParens-=1),2===e&&(this.numberOfNestedLBraces-=1),e}top(){return i.last(this.stack)}isWithinGroupExpressionContext(){return this.numberOfNestedLParens>0}isWithinListExpressionContext(){return this.numberOfNestedLBrackets>0}isWithinBlockExpressionContext(){return this.numberOfNestedLBraces>0}withContextDo(e,t){return()=>{this.push(e);try{return t()}finally{this.pop()}}}findHandlerContext(e,t){if(!(this.numberOfNestedLBraces<=0&&this.numberOfNestedLBrackets<=0&&this.numberOfNestedLParens<=0))for(let n=t;n<e.length-1;n+=1)switch(e[n].kind){case a.COMMA:if(this.isWithinGroupExpressionContext()||this.isWithinListExpressionContext())return[...this.stack].reverse().find((e=>[1,0].includes(e)));break;case a.RPAREN:if(this.isWithinGroupExpressionContext())return 1;break;case a.RBRACE:if(this.isWithinBlockExpressionContext())return 2;break;case a.RBRACKET:if(this.isWithinListExpressionContext())return 0}}}class Ue{constructor(e){this.generator=e}create(e,t){return new e(t,this.generator.nextId())}}class Me{constructor(e,t,n){this.token=e,this.partialNode=t,this.handlerContext=n}}class Fe{constructor(e,t){this.current=0,this.errors=[],this.contextStack=new Re,this.synchronizeProgram=()=>{const e=this.peek();e.kind!==a.EOF?_e(this.advance()):(_e(this.peek()),this.logError(e,be.UNEXPECTED_EOF,"Unexpected EOF"))},this.synchronizeElementDeclarationName=()=>{for(;!this.isAtEnd();){const e=this.peek();if(Le(e)||this.check(a.COLON,a.LBRACE,a.LBRACKET))break;_e(e),this.advance()}},this.synchronizeElementDeclarationAlias=()=>{for(;!this.isAtEnd();){const e=this.peek();if(this.check(a.COLON,a.LBRACE,a.LBRACKET))break;_e(e),this.advance()}},this.blockExpression=this.contextStack.withContextDo(xe.BlockExpression,(()=>{const e={body:[]},t=()=>this.nodeFactory.create(w,e);try{this.consume("Expect an opening brace '{'",a.LBRACE),e.blockOpenBrace=this.previous()}catch(n){if(!(n instanceof Me))throw n;if(e.blockOpenBrace=n.partialNode,!this.canHandle(n))throw new Me(n.token,t(),n.handlerContext);this.synchronizeBlock()}for(;!this.isAtEnd()&&!this.check(a.RBRACE);)try{if(this.match(a.TILDE)){const t=this.previous(),n=this.variable(),i=this.nodeFactory.create(C,{op:t,partial:n});e.body.push(i)}else e.body.push(this.canBeField()?this.fieldDeclaration():this.expression())}catch(n){if(!(n instanceof Me))throw n;if(e.body.push(n.partialNode),!this.canHandle(n))throw new Me(n.token,t(),n.handlerContext);this.synchronizeBlock()}try{this.consume("Expect a closing brace '}'",a.RBRACE),e.blockCloseBrace=this.previous()}catch(n){if(!(n instanceof Me))throw n;if(e.blockCloseBrace=n.partialNode,!this.canHandle(n))throw new Me(n.token,t(),n.handlerContext);this.synchronizeBlock()}return t()})),this.synchronizeBlock=()=>{if(!this.check(a.RBRACE))for(_e(this.advance());!this.isAtEnd();){const e=this.peek();if(this.check(a.RBRACE)||h(this.previous(),e))break;_e(e),this.advance()}},this.tupleExpression=this.contextStack.withContextDo(xe.GroupExpression,(()=>{const e={elementList:[],commaList:[]},t=()=>this.nodeFactory.create(P,{groupOpenParen:e.tupleOpenParen,groupCloseParen:e.tupleCloseParen,expression:e.elementList[0]}),n=()=>this.nodeFactory.create(S,e);try{this.consume("Expect an opening parenthesis '('",a.LPAREN),e.tupleOpenParen=this.previous()}catch(t){if(!(t instanceof Me))throw t;if(e.tupleOpenParen=t.partialNode,!this.canHandle(t))throw new Me(t.token,n(),t.handlerContext);this.synchronizeTuple()}if(!this.isAtEnd()&&!this.check(a.RPAREN))try{e.elementList.push(this.normalExpression())}catch(n){if(!(n instanceof Me))throw n;if(e.elementList.push(n.partialNode),!this.canHandle(n))throw new Me(n.token,t(),n.handlerContext);this.synchronizeTuple()}for(;!this.isAtEnd()&&!this.check(a.RPAREN);)try{this.consume("Expect a comma ','",a.COMMA),e.commaList.push(this.previous()),e.elementList.push(this.normalExpression())}catch(t){if(!(t instanceof Me))throw t;if(t.partialNode instanceof f&&e.elementList.push(t.partialNode),!this.canHandle(t))throw new Me(t.token,n(),t.handlerContext);this.synchronizeTuple()}try{this.consume("Expect a closing parenthesis ')'",a.RPAREN),e.tupleCloseParen=this.previous()}catch(t){if(!(t instanceof Me))throw t;if(e.tupleCloseParen=t.partialNode,!this.canHandle(t))throw new Me(t.token,n(),t.handlerContext);this.synchronizeTuple()}return 1===e.elementList.length?t():n()})),this.synchronizeTuple=()=>{for(;!this.isAtEnd();){const e=this.peek();if(this.check(a.RPAREN,a.COMMA))break;_e(e),this.advance()}},this.listExpression=this.contextStack.withContextDo(xe.ListExpression,(()=>{const e={elementList:[],commaList:[]},t=()=>this.nodeFactory.create(k,e);try{this.consume("Expect an opening bracket '['",a.LBRACKET),e.listOpenBracket=this.previous()}catch(n){if(!(n instanceof Me))throw n;if(e.listOpenBracket=n.partialNode,!this.canHandle(n))throw new Me(n.token,t(),n.handlerContext);this.synchronizeList()}if(!this.isAtEnd()&&!this.check(a.RBRACKET))try{e.elementList.push(this.attribute())}catch(n){if(!(n instanceof Me))throw n;if(e.elementList.push(n.partialNode),!this.canHandle(n))throw new Me(n.token,t(),n.handlerContext);this.synchronizeList()}for(;!this.isAtEnd()&&!this.check(a.RBRACKET);)try{this.consume("Expect a comma ','",a.COMMA),e.commaList.push(this.previous()),e.elementList.push(this.attribute())}catch(n){if(!(n instanceof Me))throw n;if(n.partialNode instanceof f&&e.elementList.push(n.partialNode),!this.canHandle(n))throw new Me(n.token,t(),n.handlerContext);this.synchronizeList()}try{this.consume("Expect a closing bracket ']'",a.RBRACKET),e.listCloseBracket=this.previous()}catch(n){if(!(n instanceof Me))throw n;if(e.listCloseBracket=n.partialNode,!this.canHandle(n))throw new Me(n.token,t(),n.handlerContext);this.synchronizeList()}return t()})),this.synchronizeList=()=>{for(;!this.isAtEnd();){const e=this.peek();if(this.check(a.COMMA,a.RBRACKET))break;_e(e),this.advance()}},this.synchronizeAttributeName=()=>{for(;!this.isAtEnd();){const e=this.peek();if(this.check(a.COMMA,a.RBRACKET,a.COLON))break;_e(e),this.advance()}},this.synchronizeAttributeValue=()=>{for(;!this.isAtEnd();){const e=this.peek();if(this.check(a.COMMA,a.RBRACKET))break;_e(e),this.advance()}},this.tokens=e,this.nodeFactory=new Ue(t)}isAtEnd(){return this.current>=this.tokens.length||this.tokens[this.current].kind===a.EOF}advance(){return this.isAtEnd()?i.last(this.tokens):this.tokens[this.current++]}peek(e=0){return e+this.current>=this.tokens.length?i.last(this.tokens):this.tokens[this.current+e]}match(...e){const t=this.check(...e);return t&&this.advance(),t}check(...e){const t=this.peek();return e.includes(t.kind)}previous(){return this.tokens[this.current-1]}canHandle(e){return void 0===e.handlerContext||e.handlerContext===this.contextStack.top()}consume(e,...t){if(!this.match(...t))throw this.logError(this.peek(),be.UNEXPECTED_TOKEN,e),new Me(this.peek(),void 0,this.contextStack.findHandlerContext(this.tokens,this.current))}discardUntil(e,...t){if(this.isAtEnd()||!this.check(...t)){for(_e(this.peek()),this.logError(this.advance(),be.UNEXPECTED_TOKEN,e);!this.isAtEnd()&&!this.check(...t);)_e(this.advance());return!this.isAtEnd()}return!0}gatherInvalid(){const e=[],t=[];let n,i=0;for(;i<this.tokens.length&&this.tokens[i].isInvalid;i+=1)t.push(this.tokens[i]);for(n=this.tokens[i],n.leadingInvalid=t,e.push(n),i+=1;i<this.tokens.length;i+=1){const t=this.tokens[i];t.isInvalid?n.trailingInvalid.push(t):(n=t,e.push(n))}this.tokens=e}parse(){const e=this.program(),t=this.advance(),n=this.nodeFactory.create(T,{body:e,eof:t});return this.gatherInvalid(),new ve({ast:n,tokens:this.tokens},this.errors)}program(){const e=[];for(;!this.isAtEnd();)try{const t=this.elementDeclaration();e.push(t)}catch(t){if(!(t instanceof Me))throw t;e.push(t.partialNode),this.synchronizeProgram()}return e}elementDeclaration(){const e={},t=()=>this.nodeFactory.create(b,e);try{this.consume("Expect an identifier",a.IDENTIFIER),e.type=this.previous()}catch(n){throw n instanceof Me?(e.type=n.partialNode,new Me(n.token,t(),n.handlerContext)):n}if(!this.check(a.COLON,a.LBRACE,a.LBRACKET))try{e.name=this.normalExpression()}catch(n){if(!(n instanceof Me))throw n;if(e.name=n.partialNode,!this.canHandle(n))throw new Me(n.token,t(),n.handlerContext);this.synchronizeElementDeclarationName()}if(Le(this.peek()))if(e.as=this.advance(),this.check(a.COLON,a.LBRACE,a.LBRACKET))this.logError(this.peek(),be.UNEXPECTED_TOKEN,"Expect an alias");else try{e.alias=this.normalExpression()}catch(n){if(!(n instanceof Me))throw n;if(e.alias=n.partialNode,!this.canHandle(n))throw new Me(n.token,t(),n.handlerContext);this.synchronizeElementDeclarationAlias()}try{e.attributeList=this.check(a.LBRACKET)?this.listExpression():void 0}catch(n){throw n instanceof Me?(e.attributeList=n.partialNode,new Me(n.token,t(),n.handlerContext)):n}if(!this.discardUntil("Expect an opening brace '{' or a colon ':'",a.LBRACE,a.COLON))return t();try{if(this.match(a.COLON)){e.bodyColon=this.previous();const t=this.expression();t instanceof b?(_e(t),this.logError(t,be.UNEXPECTED_ELEMENT_DECLARATION,"An element's simple body must not be an element declaration")):e.body=t}else e.body=this.blockExpression()}catch(n){throw n instanceof Me?(e.body=n.partialNode,new Me(n.token,t(),n.handlerContext)):n}return this.nodeFactory.create(b,e)}fieldDeclaration(){const e={},t=()=>this.nodeFactory.create(b,e);try{this.consume("Expect an identifier",a.IDENTIFIER),e.type=this.previous()}catch(n){throw n instanceof Me?(e.type=n.partialNode,new Me(n.token,t(),n.handlerContext)):n}try{this.consume("Expect a colon ':'",a.COLON),e.bodyColon=this.previous()}catch(n){throw n instanceof Me?(e.bodyColon=n.partialNode,new Me(n.token,t(),n.handlerContext)):n}try{const t=this.expression();t instanceof b?this.errors.push(new Ie(be.INVALID_ELEMENT_IN_SIMPLE_BODY,"Simple body cannot be an element declaration",t)):e.body=t}catch(n){throw n instanceof Me?(e.body=n.partialNode,new Me(n.token,t(),n.handlerContext)):n}return this.nodeFactory.create(b,e)}expression(){const e={args:[]},t=()=>function(e,t,n){if(!e||!Se(e)||0===t.length)return new V;const s=[...t],a=we(e).unwrap(),r=s.pop();if(!(r instanceof w))return new V;const o=i.last(s)instanceof k?s.pop():void 0;if(3===s.length){const e=we(s[1]).value;return e&&Le(e)?new B(n.create(b,{type:a,name:s[0],as:e,alias:s[2],attributeList:o,body:r})):new V}return 1===s.length?new B(n.create(b,{type:a,name:s[0],attributeList:o,body:r})):0===s.length?new B(n.create(b,{type:a,attributeList:o,body:r})):new V}(e.callee,e.args,this.nodeFactory).unwrap_or(this.nodeFactory.create(g,e));try{e.callee=this.normalExpression()}catch(n){throw n instanceof Me?(e.callee=n.partialNode,new Me(n.token,t(),n.handlerContext)):n}if(this.shouldStopExpression())return t();let n=e.callee;for(;!this.shouldStopExpression();){d(this.previous())||this.logError(n,be.MISSING_SPACES,"Expect a following space");try{n=this.normalExpression(),e.args.push(n)}catch(i){throw i instanceof Me?(n=i.partialNode,e.args.push(n),new Me(i.token,t(),i.handlerContext)):i}}return t()}shouldStopExpression(){if(this.isAtEnd()||u(this.previous()))return!0;const e=this.peek().kind;return e===a.RBRACE||e===a.RBRACKET||e===a.RPAREN||e===a.COMMA||e===a.COLON}normalExpression(){return this.expression_bp(0)}expression_bp(e){let t=this.leftExpression_bp();for(;!this.isAtEnd();){const n=this.peek();if(n.kind===a.LPAREN){const{left:i}=Ke(n);if(i<e||h(this.previous(),n)&&!this.contextStack.isWithinGroupExpressionContext()&&!this.contextStack.isWithinListExpressionContext())break;try{t=this.nodeFactory.create(D,{callee:t,argumentList:this.tupleExpression()})}catch(e){throw e instanceof Me?(t=this.nodeFactory.create(D,{callee:t,argumentList:e.partialNode}),new Me(e.token,t,e.handlerContext)):e}}else if(n.kind===a.LBRACKET){if(d(this.previous()))break;try{t=this.nodeFactory.create(M,{expression:t,indexer:this.listExpression()})}catch(e){throw e instanceof Me?(t=this.nodeFactory.create(M,{expression:t,indexer:e.partialNode}),new Me(e.token,t,e.handlerContext)):e}}else{if(!l(n))break;{const i=n,s=Ke(i);if(null!==s.left){if(s.left<=e)break;this.advance(),t=this.nodeFactory.create(A,{expression:t,op:i})}else{const n=Ve(i);if(null===n.left||n.left<=e)break;this.advance();try{t=this.nodeFactory.create(_,{leftExpression:t,op:i,rightExpression:"."===i.value?this.extractOperand():this.expression_bp(n.right)})}catch(e){throw e instanceof Me?(t=this.nodeFactory.create(_,{leftExpression:t,op:i,rightExpression:e.partialNode}),new Me(e.token,t,e.handlerContext)):e}}}}}return t}leftExpression_bp(){let e;if(l(this.peek())){const t={};t.op=this.peek();const n=function(e){return Ge[e.value]||{left:null,right:null}}(t.op);if(null===n.right)throw this.logError(t.op,be.UNKNOWN_PREFIX_OP,`Unexpected '${t.op.value}' in an expression`),new Me(t.op,this.nodeFactory.create(U,{pre:t.op}),this.contextStack.findHandlerContext(this.tokens,this.current));this.advance();try{t.expression=this.expression_bp(n.right)}catch(e){throw e instanceof Me?(t.expression=e.partialNode,new Me(e.token,this.nodeFactory.create(L,t),e.handlerContext)):e}e=this.nodeFactory.create(L,t)}else if(e=this.extractOperand(),e instanceof U)throw new Me(this.peek(),this.nodeFactory.create(U,{pre:this.peek()}),this.contextStack.findHandlerContext(this.tokens,this.current));return e}extractOperand(){return this.check(a.NUMERIC_LITERAL,a.STRING_LITERAL,a.COLOR_LITERAL,a.QUOTED_STRING,a.IDENTIFIER)?this.primaryExpression():this.check(a.FUNCTION_EXPRESSION)?this.functionExpression():this.check(a.LBRACKET)?this.listExpression():this.check(a.LBRACE)?this.blockExpression():this.check(a.LPAREN)?this.tupleExpression():(this.peek().kind===a.EOF?this.logError(this.peek(),be.UNEXPECTED_EOF,"Unexpected EOF"):this.logError(this.peek(),be.INVALID_OPERAND,`Invalid start of operand "${this.peek().value}"`),this.nodeFactory.create(U,{pre:this.previous()}))}functionExpression(){const e={};try{this.consume("Expect a function expression",a.FUNCTION_EXPRESSION),e.value=this.previous()}catch(t){throw t instanceof Me?(e.value=t.partialNode,new Me(t.token,this.nodeFactory.create(y,e),t.handlerContext)):t}return this.nodeFactory.create(y,e)}variable(){this.consume("Expect a variable",a.IDENTIFIER);const e=this.previous();return this.nodeFactory.create(x,{variable:e})}canBeField(){return this.peek().kind===a.IDENTIFIER&&this.peek(1).kind===a.COLON}primaryExpression(){if(this.match(a.COLOR_LITERAL,a.STRING_LITERAL,a.NUMERIC_LITERAL))return this.nodeFactory.create(R,{expression:this.nodeFactory.create(O,{literal:this.previous()})});if(this.match(a.QUOTED_STRING,a.IDENTIFIER))return this.nodeFactory.create(R,{expression:this.nodeFactory.create(x,{variable:this.previous()})});throw this.logError(this.peek(),be.UNEXPECTED_TOKEN,"Expect a variable or literal"),new Me(this.peek(),void 0,this.contextStack.findHandlerContext(this.tokens,this.current))}attribute(){const e={};if(this.check(a.COLON,a.RBRACKET,a.COMMA)){const t=this.peek();this.logError(t,be.EMPTY_ATTRIBUTE_NAME,"Expect a non-empty attribute name"),e.name=this.nodeFactory.create(I,{identifiers:[]})}else try{e.name=this.attributeName()}catch(t){if(!(t instanceof Me))throw t;if(e.name=t.partialNode,!this.canHandle(t))throw new Me(t.token,this.nodeFactory.create(v,e),t.handlerContext);this.synchronizeAttributeName()}return this.match(a.COLON)&&(e.colon=this.previous(),e.value=this.attributeValue()),this.nodeFactory.create(v,e)}attributeValue(){let e;try{e=this.peek().kind===a.IDENTIFIER&&this.peek(1).kind===a.IDENTIFIER?this.attributeName():this.normalExpression()}catch(t){if(!(t instanceof Me&&this.canHandle(t)))throw t;e=t.partialNode,this.synchronizeAttributeValue()}return e}attributeName(){const e=[];if(this.peek().kind!==a.IDENTIFIER)return this.primaryExpression();for(;!this.isAtEnd()&&!this.check(a.COLON,a.COMMA,a.RBRACKET);)try{this.consume("Expect an identifier",a.IDENTIFIER),e.push(this.previous())}catch(t){throw t instanceof Me?new Me(t.token,this.nodeFactory.create(I,{identifiers:e}),t.handlerContext):t}return this.nodeFactory.create(I,{identifiers:e})}logError(e,t,n){this.errors.push(new Ie(t,n,e))}}const Be={"+":{left:9,right:10},"*":{left:11,right:12},"-":{left:9,right:10},"/":{left:11,right:12},"%":{left:11,right:12},"<":{left:7,right:8},"<=":{left:7,right:8},">":{left:7,right:8},">=":{left:7,right:8},"<>":{left:7,right:8},"=":{left:2,right:3},"==":{left:4,right:5},"!=":{left:4,right:5},".":{left:16,right:17}};function Ve(e){return Be[e.value]||{left:null,right:null}}const Ge={"+":{left:null,right:15},"-":{left:null,right:15},"<":{left:null,right:15},">":{left:null,right:15},"<>":{left:null,right:15},"!":{left:null,right:15}};const Xe={"(":{left:14,right:null}};function Ke(e){return Xe[e.value]||{left:null,right:null}}var $e=(e=>(e.Table="table",e.Enum="enum",e.Ref="ref",e.Note="note",e.Project="project",e.Indexes="indexes",e.TableGroup="tablegroup",e.TablePartial="tablepartial",e))($e||{}),je=(e=>(e.Color="color",e.HeaderColor="headercolor",e.Note="note",e.PK="pk",e.PKey="primary key",e.Unique="unique",e.Ref="ref",e.NotNull="not null",e.Null="null",e.Increment="increment",e.Default="default",e.Name="name",e.Type="type",e.Update="update",e.Delete="delete",e))(je||{});function We(e){var t;const n=null==(t=null==e?void 0:e.type)?void 0:t.value.toLowerCase();switch(n){case $e.Enum:case $e.Table:case $e.Indexes:case $e.Note:case $e.Project:case $e.Ref:case $e.TableGroup:case $e.TablePartial:return new B(n);default:return new V}}function qe(e){if(!Pe(e))return new B([e]);const t=qe(e.leftExpression).unwrap_or(void 0);return t?(t.push(e.rightExpression),new B(t)):new V}function Ye(e){if(void 0===e)return new V;const t=qe(e).unwrap_or(void 0);if(!t)return new V;const n=[];for(const e of t){const t=ze(e).unwrap_or(void 0);if(!t)return new V;n.push(t)}return new B(n)}function He(e){if(void 0===e)return new V;const t=qe(e).unwrap_or(void 0);if(!t||0===t.length)return new V;const n=[];let s;if(!ke(i.last(t))){const e=t.pop();if(!yt(e))return new V;s=e.elementList.map((e=>Je(e).unwrap()))}for(const e of t){const t=ze(e).unwrap_or(void 0);if(!t)return new V;n.push(t)}return new B({variables:n,tupleElements:s})}function ze(e){return ke(e)?new B(e.expression.variable.value):new V}function Qe(e){if(tt(e))return new B(e instanceof y?{functional:[e],nonFunctional:[]}:{functional:[],nonFunctional:[e]});if(e instanceof S&&e.elementList.every(tt)){const t=e.elementList.filter((e=>e instanceof y)),n=e.elementList.filter(ke);return new B({functional:t,nonFunctional:n})}return new V}function Je(e){var t;const n=null==(t=null==e?void 0:e.expression.variable)?void 0:t.value;return void 0===n?new V:new B(n)}function Ze(e){var t,n;const i=null==(n=null==(t=null==e?void 0:e.partial)?void 0:t.variable)?void 0:n.value;return void 0===i?new V:new B(i)}function et(e){return Ce(e)?e.expression instanceof x?new B(e.expression.variable.value):new B(e.expression.literal.value):new V}function tt(e){return e instanceof R&&e.expression instanceof x||e instanceof y}function nt(e,t){var n,i,s,a;let r=t;const o=function(e){const t=J(e).unwrap_or(void 0);if(!t)return!1;const{kind:n,name:i}=t;return"Schema"===n&&"public"===i}(e);for(;r;){if(null!=(i=null==(n=r.symbol)?void 0:n.symbolTable)&&i.has(e))return null==(s=r.symbol.symbolTable)?void 0:s.get(e);if((null==(a=r.symbol)?void 0:a.declaration)instanceof T&&o)return r.symbol;if(r instanceof T)return;r=r.parent}}class it{constructor(e,t,n){this.declarationNode=e,this.publicSymbolTable=t,this.symbolFactory=n}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof T||We(this.declarationNode.parent).unwrap_or(void 0)!==$e.Project?[new Ie(be.INVALID_CUSTOM_CONTEXT,"A custom element can only appear in a Project",this.declarationNode)]:[]}validateName(e){return e?[new Ie(be.UNEXPECTED_NAME,"A Custom element shouldn't have a name",e)]:[]}validateAlias(e){return e?[new Ie(be.UNEXPECTED_NAME,"A Custom element shouldn't have an alias",e)]:[]}validateSettingList(e){return e?[new Ie(be.UNEXPECTED_SETTINGS,"A Custom element shouldn't have a setting list",e)]:[]}validateBody(e){if(!e)return[];if(e instanceof w)return[new Ie(be.UNEXPECTED_COMPLEX_BODY,"A Custom element can only have an inline field",e)];const t=[];return Ce(e.callee)||t.push(new Ie(be.INVALID_CUSTOM_ELEMENT_VALUE,"A Custom element value can only be a string",e)),e.args.length>0&&t.push(...e.args.map((e=>new Ie(be.INVALID_CUSTOM_ELEMENT_VALUE,"A Custom element value can only be a string",e)))),t}}class st{constructor(){this.table=new Map}has(e){return this.table.has(e)}set(e,t){this.table.set(e,t)}get(e,t){return this.table.get(e)||void 0!==t&&this.set(e,t)||t}entries(){return this.table.entries()}forEach(e){return this.table.forEach(e)}}class at{constructor(e,t,n){this.declarationNode=e,this.publicSymbolTable=t,this.symbolFactory=n}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.registerElement(),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof b?[new Ie(be.INVALID_PROJECT_CONTEXT,"An Enum can only appear top-level",this.declarationNode)]:[]}validateName(e){return e?ft(e)?[]:[new Ie(be.INVALID_NAME,"An Enum name must be of the form <enum> or <schema>.<enum>",e)]:[new Ie(be.NAME_NOT_FOUND,"An Enum must have a name",this.declarationNode)]}validateAlias(e){return e?[new Ie(be.UNEXPECTED_ALIAS,"A Ref shouldn't have an alias",e)]:[]}registerElement(){const e=[];this.declarationNode.symbol=this.symbolFactory.create(te,{declaration:this.declarationNode,symbolTable:new st});const{name:t}=this.declarationNode,n=Ye(t);if(n.isOk()){const i=n.unwrap(),s=i.pop(),a=Tt(i,this.publicSymbolTable,this.symbolFactory),r=j(s);a.has(r)&&e.push(new Ie(be.DUPLICATE_NAME,`Enum name ${s} already exists in schema '${i.join(".")||"public"}'`,t)),a.set(r,this.declarationNode.symbol)}return e}validateSettingList(e){return e?[new Ie(be.UNEXPECTED_SETTINGS,"An Enum shouldn't have a setting list",e)]:[]}validateBody(e){if(!e)return[];if(e instanceof g)return this.validateFields([e]);const[t,n]=i.partition(e.body,(e=>e instanceof g));return[...this.validateFields(t),...this.validateSubElements(n)]}validateFields(e){return 0===e.length?[new Ie(be.EMPTY_ENUM,"An Enum must have at least one element",this.declarationNode)]:e.flatMap((e=>{const t=[];e.callee&&!ke(e.callee)&&t.push(new Ie(be.INVALID_ENUM_ELEMENT_NAME,"An enum field must be an identifier or a quoted identifier",e.callee));const n=[...e.args];return i.last(n)instanceof k?(t.push(...this.validateFieldSettings(i.last(n))),n.pop()):n[0]instanceof k&&(t.push(...this.validateFieldSettings(n[0])),n.shift()),n.length>0&&t.push(...n.map((e=>new Ie(be.INVALID_ENUM_ELEMENT,"An Enum must have only a field and optionally a setting list",e)))),t.push(...this.registerField(e)),t}))}validateFieldSettings(e){const t=wt(e),n=t.getErrors(),i=t.getValue();for(const e in i){const t=i[e];if("note"===e)t.length>1&&t.forEach((e=>n.push(new Ie(be.DUPLICATE_ENUM_ELEMENT_SETTING,"'note' can only appear once",e)))),t.forEach((e=>{Ce(e.value)||n.push(new Ie(be.INVALID_ENUM_ELEMENT_SETTING,"'note' must be a string",e))}));else t.forEach((t=>n.push(new Ie(be.UNKNOWN_ENUM_ELEMENT_SETTING,`Unknown enum field setting '${e}'`,t))))}return n}validateSubElements(e){return e.flatMap((e=>{if(e.parent=this.declarationNode,!e.type)return[];return new(Nt(e))(e,this.publicSymbolTable,this.symbolFactory).validate()}))}registerField(e){if(e.callee&&ke(e.callee)){const t=Je(e.callee).unwrap(),n=W(t),i=this.symbolFactory.create(ne,{declaration:e});e.symbol=i;const s=this.declarationNode.symbol.symbolTable;if(s.has(n)){const i=s.get(n);return[new Ie(be.DUPLICATE_COLUMN_NAME,`Duplicate enum field ${t}`,e),new Ie(be.DUPLICATE_COLUMN_NAME,`Duplicate enum field ${t}`,i.declaration)]}s.set(n,i)}return[]}}class rt{constructor(e,t,n){this.declarationNode=e,this.publicSymbolTable=t,this.symbolFactory=n}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.validateBody(this.declarationNode.body)]}validateContext(){const e=new Ie(be.INVALID_INDEXES_CONTEXT,"An Indexes can only appear inside a Table or a TablePartial",this.declarationNode);if(this.declarationNode.parent instanceof T)return[e];const t=We(this.declarationNode.parent).unwrap_or(void 0);return t&&[$e.Table,$e.TablePartial].includes(t)?[]:[e]}validateName(e){return e?[new Ie(be.UNEXPECTED_NAME,"An Indexes shouldn't have a name",e)]:[]}validateAlias(e){return e?[new Ie(be.UNEXPECTED_ALIAS,"An Indexes shouldn't have an alias",e)]:[]}validateSettingList(e){return e?[new Ie(be.UNEXPECTED_SETTINGS,"An Indexes shouldn't have a setting list",e)]:[]}validateBody(e){if(!e)return[];if(e instanceof g)return[new Ie(be.UNEXPECTED_SIMPLE_BODY,"An Indexes must have a complex body",e)];const[t,n]=i.partition(e.body,(e=>e instanceof g));return[...this.validateFields(t),...this.validateSubElements(n)]}validateFields(e){return e.flatMap((e=>{if(!e.callee)return[];const t=[],n=[e.callee,...e.args];return i.last(n)instanceof k&&t.push(...this.validateFieldSetting(n.pop())),n.forEach((e=>{for(;e instanceof D;)e.argumentList&&!Qe(e.argumentList).isOk()&&t.push(new Ie(be.INVALID_INDEXES_FIELD,"An index field must be an identifier, a quoted identifier, a functional expression or a tuple of such",e.argumentList)),e=e.callee;Qe(e).isOk()||t.push(new Ie(be.INVALID_INDEXES_FIELD,"An index field must be an identifier, a quoted identifier, a functional expression or a tuple of such",e))})),t}))}validateFieldSetting(e){const t=wt(e),n=t.getErrors(),i=t.getValue();for(const e in i){const t=i[e];switch(e){case"note":case"name":t.length>1&&t.forEach((t=>n.push(new Ie(be.DUPLICATE_INDEX_SETTING,`'${e}' can only appear once`,t)))),t.forEach((t=>{Ce(t.value)||n.push(new Ie(be.INVALID_INDEX_SETTING_VALUE,`'${e}' must be a string`,t))}));break;case"unique":case"pk":t.length>1&&t.forEach((t=>n.push(new Ie(be.DUPLICATE_INDEX_SETTING,`'${e}' can only appear once`,t)))),t.forEach((t=>{vt(t.value)||n.push(new Ie(be.INVALID_INDEX_SETTING_VALUE,`'${e}' must not have a value`,t))}));break;case"type":t.length>1&&t.forEach((e=>n.push(new Ie(be.DUPLICATE_INDEX_SETTING,"'type' can only appear once",e)))),t.forEach((e=>{ke(e.value)||n.push(new Ie(be.INVALID_INDEX_SETTING_VALUE,'\'type\' must be "btree" or "hash"',e))}));break;default:t.forEach((t=>n.push(new Ie(be.UNKNOWN_INDEX_SETTING,`Unknown index setting '${e}'`,t))))}}return n}validateSubElements(e){return e.flatMap((e=>{if(e.parent=this.declarationNode,!e.type)return[];return new(Nt(e))(e,this.publicSymbolTable,this.symbolFactory).validate()}))}}class ot{constructor(e,t,n){this.declarationNode=e,this.publicSymbolTable=t,this.symbolFactory=n}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof T||[$e.Table,$e.TableGroup,$e.TablePartial,$e.Project].includes(We(this.declarationNode.parent).unwrap_or(void 0))?[]:[new Ie(be.INVALID_NOTE_CONTEXT,"A Note can only appear inside a Table, a TableGroup, a TablePartial or a Project. Sticky note can only appear at the global scope.",this.declarationNode)]}validateName(e){if(!(this.declarationNode.parent instanceof T))return e?[new Ie(be.UNEXPECTED_NAME,"A Note shouldn't have a name",e)]:[];if(!e)return[new Ie(be.INVALID_NAME,"Sticky note must have a name",this.declarationNode)];const t=Ye(e);if(!t.isOk())return[new Ie(be.INVALID_NAME,"Invalid name for sticky note ",this.declarationNode)];const n=t.unwrap().join("."),i=function(e){return`Note:${e}`}(n);return this.publicSymbolTable.has(i)?[new Ie(be.DUPLICATE_NAME,`Sticky note "${n}" has already been defined`,e)]:(this.publicSymbolTable.set(i,this.declarationNode.symbol),[])}validateAlias(e){return e?[new Ie(be.UNEXPECTED_ALIAS,"A Ref shouldn't have an alias",e)]:[]}validateSettingList(e){return e?[new Ie(be.UNEXPECTED_SETTINGS,"A Note shouldn't have a setting list",e)]:[]}validateBody(e){if(!e)return[];if(e instanceof g)return this.validateFields([e]);const[t,n]=i.partition(e.body,(e=>e instanceof g));return[...this.validateFields(t),...this.validateSubElements(n)]}validateFields(e){const t=[];return 0===e.length?[new Ie(be.EMPTY_NOTE,"A Note must have a content",this.declarationNode)]:(e.length>1&&e.slice(1).forEach((e=>t.push(new Ie(be.NOTE_CONTENT_REDEFINED,"A Note can only contain one string",e)))),Ce(e[0].callee)||t.push(new Ie(be.INVALID_NOTE,"A Note content must be a quoted string",e[0])),e[0].args.length>0&&t.push(...e[0].args.map((e=>new Ie(be.INVALID_NOTE,"A Note can only contain one quoted string",e)))),t)}validateSubElements(e){return e.flatMap((e=>{if(e.parent=this.declarationNode,!e.type)return[];return new(Nt(e))(e,this.publicSymbolTable,this.symbolFactory).validate()}))}}class lt{constructor(e,t,n){this.declarationNode=e,this.publicSymbolTable=t,this.symbolFactory=n}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof b?[new Ie(be.INVALID_PROJECT_CONTEXT,"A Project can only appear top-level",this.declarationNode)]:[]}validateName(e){return e?mt(e)?[]:[new Ie(be.INVALID_NAME,"A Project's name is optional or must be an identifier or a quoted identifer",e)]:[]}validateAlias(e){return e?[new Ie(be.UNEXPECTED_ALIAS,"A Project shouldn't have an alias",e)]:[]}validateSettingList(e){return e?[new Ie(be.UNEXPECTED_SETTINGS,"A Project shouldn't have a setting list",e)]:[]}validateBody(e){if(!e)return[];if(e instanceof g)return[new Ie(be.UNEXPECTED_SIMPLE_BODY,"A Project's body must be a block",e)];const[t,n]=i.partition(e.body,(e=>e instanceof g));return[...t.map((e=>new Ie(be.INVALID_PROJECT_FIELD,"A Project can not have inline fields",e))),...this.validateSubElements(n)]}validateSubElements(e){return e.flatMap((e=>{if(e.parent=this.declarationNode,!e.type)return[];return new(Nt(e))(e,this.publicSymbolTable,this.symbolFactory).validate()}))}}class ct{constructor(e,t,n){this.declarationNode=e,this.publicSymbolTable=t,this.symbolFactory=n}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof T?[]:[new Ie(be.INVALID_REF_CONTEXT,"A Ref must appear top-level",this.declarationNode)]}validateName(e){return e?mt(e)?[]:[new Ie(be.INVALID_NAME,"A Ref's name is optional or must be an identifier or a quoted identifer",e)]:[]}validateAlias(e){return e?[new Ie(be.UNEXPECTED_ALIAS,"A Ref shouldn't have an alias",e)]:[]}validateSettingList(e){return e?[new Ie(be.UNEXPECTED_SETTINGS,"A Ref shouldn't have a setting list",e)]:[]}validateBody(e){if(!e)return[];if(e instanceof g)return this.validateFields([e]);const[t,n]=i.partition(e.body,(e=>e instanceof g));return[...this.validateFields(t),...this.validateSubElements(n)]}validateFields(e){if(0===e.length)return[new Ie(be.EMPTY_REF,"A Ref must have at least one field",this.declarationNode)];const t=[];return e.length>1&&t.push(...e.slice(1).map((e=>new Ie(be.REF_REDEFINED,"A Ref can only contain one binary relationship",e)))),e.forEach((e=>{e.callee&&!function(e){var t;return!!(e instanceof _&&bt(null==(t=e.op)?void 0:t.value))&&void 0!==He(e.leftExpression).and_then((()=>He(e.rightExpression))).unwrap_or(void 0)}(e.callee)&&t.push(new Ie(be.INVALID_REF_FIELD,"A Ref field must be a binary relationship",e.callee)),e.callee&&!function(e){const t=He(e.leftExpression),n=He(e.rightExpression);if(!t.isOk()||!n.isOk())return!1;const{tupleElements:i}=t.unwrap(),{tupleElements:s}=n.unwrap();return(null==i?void 0:i.length)===(null==s?void 0:s.length)}(e.callee)&&t.push(new Ie(be.UNEQUAL_FIELDS_BINARY_REF,"Unequal fields in ref endpoints",e.callee));const n=[...e.args];if(i.last(n)instanceof k){const e=this.validateFieldSettings(i.last(n));t.push(...e),n.pop()}else n[0]instanceof k&&(t.push(...this.validateFieldSettings(n[0])),n.shift());n.length>0&&t.push(...n.map((e=>new Ie(be.INVALID_REF_FIELD,"A Ref field should only have a single binary relationship",e))))})),t}validateFieldSettings(e){const t=wt(e),n=t.getErrors(),i=t.getValue();for(const e in i){const t=i[e];switch(e){case"delete":case"update":t.length>1&&t.forEach((t=>n.push(new Ie(be.DUPLICATE_REF_SETTING,`'${e}' can only appear once`,t)))),t.forEach((t=>{ut(t.value)||n.push(new Ie(be.INVALID_REF_SETTING_VALUE,`'${e}' can only have values "cascade", "no action", "set null", "set default" or "restrict"`,t))}));break;case"color":t.length>1&&n.push(...t.map((e=>new Ie(be.DUPLICATE_REF_SETTING,"'color' can only appear once",e)))),t.forEach((e=>{It(e.value)||n.push(new Ie(be.INVALID_REF_SETTING_VALUE,"'color' must be a color literal",e))}));break;default:t.forEach((t=>n.push(new Ie(be.UNKNOWN_REF_SETTING,`Unknown ref setting '${e}'`,t))))}}return n}validateSubElements(e){return e.flatMap((e=>{if(e.parent=this.declarationNode,!e.type)return[];return new(Nt(e))(e,this.publicSymbolTable,this.symbolFactory).validate()}))}}function ut(e){if(!(ke(e)&&e.expression.variable.kind!==a.QUOTED_STRING||e instanceof I))return!1;let t;if(t=e instanceof I?De(e).unwrap_or(""):e.expression.variable.value,t)switch(t.toLowerCase()){case"cascade":case"no action":case"set null":case"set default":case"restrict":return!0;default:return!1}return!1}class ht{constructor(e,t,n){this.declarationNode=e,this.symbolFactory=n,this.publicSymbolTable=t}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.registerElement(),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof b?[new Ie(be.INVALID_TABLE_CONTEXT,"Table must appear top-level",this.declarationNode)]:[]}validateName(e){return e?e instanceof M?[new Ie(be.INVALID_NAME,"Invalid array as Table name, maybe you forget to add a space between the name and the setting list?",e)]:ft(e)?[]:[new Ie(be.INVALID_NAME,"A Table name must be of the form <table> or <schema>.<table>",e)]:[new Ie(be.NAME_NOT_FOUND,"A Table must have a name",this.declarationNode)]}validateAlias(e){return e?function(e){return mt(e)}(e)?[]:[new Ie(be.INVALID_ALIAS,"Table aliases can only contains alphanumeric and underscore unless surrounded by double quotes",e)]:[]}validateSettingList(e){const t=wt(e),n=t.getErrors(),s=t.getValue();return i.forIn(s,((e,t)=>{switch(t){case je.HeaderColor:e.length>1&&n.push(...e.map((e=>new Ie(be.DUPLICATE_TABLE_SETTING,"'headercolor' can only appear once",e)))),e.forEach((e=>{It(e.value)||n.push(new Ie(be.INVALID_TABLE_SETTING,"'headercolor' must be a color literal",e.value||e.name))}));break;case je.Note:e.length>1&&n.push(...e.map((e=>new Ie(be.DUPLICATE_TABLE_SETTING,"'note' can only appear once",e)))),e.forEach((e=>{Ce(e.value)||n.push(new Ie(be.INVALID_TABLE_SETTING,"'note' must be a string literal",e.value||e.name))}));break;default:n.push(...e.map((e=>new Ie(be.INVALID_TABLE_SETTING,`Unknown '${t}' setting`,e))))}})),n}registerElement(){const e=[];this.declarationNode.symbol=this.symbolFactory.create(ie,{declaration:this.declarationNode,symbolTable:new st});const{name:t,alias:n}=this.declarationNode,i=Ye(t);if(i.isOk()){const n=[...i.unwrap()],s=n.pop(),a=Tt(n,this.publicSymbolTable,this.symbolFactory),r=K(s);a.has(r)&&e.push(new Ie(be.DUPLICATE_NAME,`Table name '${s}' already exists in schema '${n.join(".")||"public"}'`,t)),a.set(r,this.declarationNode.symbol)}if(n&&mt(n)&&!function(e,t){return 1===t.length&&e===t[0]}(n.expression.variable.value,i.unwrap_or([]))){const i=Je(n).unwrap(),s=K(i);this.publicSymbolTable.has(s)&&e.push(new Ie(be.DUPLICATE_NAME,`Table name '${i}' already exists`,t)),this.publicSymbolTable.set(s,this.declarationNode.symbol)}return e}validateBody(e){if(!e)return[];if(e instanceof g)return[new Ie(be.UNEXPECTED_SIMPLE_BODY,"A Table's body must be a block",e)];const[t,n,i]=e.body.reduce(((e,t)=>(t instanceof g?e[0].push(t):t instanceof C?e[1].push(t):t instanceof b&&e[2].push(t),e)),[[],[],[]]);return[...this.validateFields(t),...this.validateInjections(n),...this.validateSubElements(i)]}validateInjections(e){return e.flatMap((e=>this.registerInjection(e)))}registerInjection(e){var t,n,i;if(null==(n=null==(t=e.partial)?void 0:t.variable)||!n.value)return[];const s=null==(i=e.partial.variable)?void 0:i.value,a=z(s),r=this.symbolFactory.create(le,{declaration:e});e.symbol=r;const o=this.declarationNode.symbol.symbolTable,l=o.get(a);return l?[new Ie(be.DUPLICATE_TABLE_PARTIAL_INJECTION_NAME,`Duplicate injection ${s}`,e),new Ie(be.DUPLICATE_TABLE_PARTIAL_INJECTION_NAME,`Duplicate injection ${s}`,l.declaration)]:(o.set(a,r),[])}validateFields(e){return e.flatMap((e=>{if(!e.callee)return[];const t=[];0===e.args.length&&t.push(new Ie(be.INVALID_COLUMN,"A column must have a type",e.callee)),ke(e.callee)||t.push(new Ie(be.INVALID_COLUMN_NAME,"A column name must be an identifier or a quoted identifier",e.callee)),e.args[0]&&!gt(e.args[0])&&t.push(new Ie(be.INVALID_COLUMN_TYPE,"Invalid column type",e.args[0]));const n=e.args.slice(1);return t.push(...this.validateFieldSetting(n)),t.push(...this.registerField(e)),t}))}registerField(e){if(e.callee&&ke(e.callee)){const t=Je(e.callee).unwrap(),n=$(t),i=this.symbolFactory.create(se,{declaration:e});e.symbol=i;const s=this.declarationNode.symbol.symbolTable;if(s.has(n)){const i=s.get(n);return[new Ie(be.DUPLICATE_COLUMN_NAME,`Duplicate column ${t}`,e),new Ie(be.DUPLICATE_COLUMN_NAME,`Duplicate column ${t}`,i.declaration)]}s.set(n,i)}return[]}validateFieldSetting(e){if(!e.slice(0,-1).every(Se)||!e.slice(-1).every((e=>Se(e)||e instanceof k)))return[...e.map((e=>new Ie(be.INVALID_COLUMN,"These fields must be some inline settings optionally ended with a setting list",e)))];if(0===e.length)return[];let t;i.last(e)instanceof k&&(t=e.pop());const n=wt(t),s=n.getErrors(),a=n.getValue();e.forEach((e=>{const t=Je(e).unwrap_or("").toLowerCase();"pk"===t||"unique"===t?void 0===a[t]?a[t]=[e]:a[t].push(e):s.push(new Ie(be.INVALID_SETTINGS,"Inline column settings can only be `pk` or `unique`",e))}));const r=a[je.PK]||[],o=a[je.PKey]||[];return r.length>=1&&o.length>=1&&s.push(...[...r,...o].map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,"Either one of 'primary key' and 'pk' can appear",e)))),i.forIn(a,((e,t)=>{switch(t){case je.Note:e.length>1&&s.push(...e.map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,"note can only appear once",e)))),e.forEach((e=>{Ce(e.value)||s.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,"'note' must be a quoted string",e.value||e.name))}));break;case je.Ref:e.forEach((e=>{At(e.value)||s.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,"'ref' must be a valid unary relationship",e.value||e.name))}));break;case je.PKey:e.length>1&&s.push(...e.map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,"primary key can only appear once",e)))),e.forEach((e=>{vt(e.value)||s.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,"'primary key' must not have a value",e.value||e.name))}));break;case je.PK:e.length>1&&s.push(...e.map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,"'pk' can only appear once",e)))),e.forEach((e=>{e instanceof v&&!vt(e.value)&&s.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,"'pk' must not have a value",e.value||e.name))}));break;case je.NotNull:{e.length>1&&s.push(...e.map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,"'not null' can only appear once",e))));const t=a[je.Null]||[];e.length>=1&&t.length>=1&&s.push(...[...e,...t].map((e=>new Ie(be.CONFLICTING_SETTING,"'not null' and 'null' can not be set at the same time",e)))),e.forEach((e=>{vt(e.value)||s.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,"'not null' must not have a value",e.value||e.name))}));break}case je.Null:e.length>1&&s.push(...e.map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,"'null' can only appear once",e)))),e.forEach((e=>{vt(e.value)||s.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,"'null' must not have a value",e.value||e.name))}));break;case je.Unique:e.length>1&&s.push(...e.map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,"'unique' can only appear once",e)))),e.forEach((e=>{e instanceof v&&!vt(e.value)&&s.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,"'unique' must not have a value",e.value||e.name))}));break;case je.Increment:e.length>1&&s.push(...e.map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,"'increment' can only appear once",e)))),e.forEach((e=>{e instanceof v&&!vt(e.value)&&s.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,"'increment' must not have a value",e.value||e.name))}));break;case je.Default:e.length>1&&s.push(...e.map((e=>new Ie(be.DUPLICATE_TABLE_SETTING,"'default' can only appear once",e)))),e.forEach((e=>{Lt(e.value)||s.push(new Ie(be.INVALID_TABLE_SETTING,"'default' must be a string literal, number literal, function expression, true, false or null",e.value||e.name))}));break;default:e.forEach((e=>s.push(new Ie(be.UNKNOWN_COLUMN_SETTING,`Unknown column setting '${t}'`,e))))}})),s}validateSubElements(e){const t=e.flatMap((e=>{if(e.parent=this.declarationNode,!e.type)return[];return new(Nt(e))(e,this.publicSymbolTable,this.symbolFactory).validate()})),n=e.filter((e=>{var t;return"note"===(null==(t=e.type)?void 0:t.value.toLowerCase())}));return n.length>1&&t.push(...n.map((e=>new Ie(be.NOTE_REDEFINED,"Duplicate notes are defined",e)))),t}}class dt{constructor(e,t,n){this.declarationNode=e,this.publicSymbolTable=t,this.symbolFactory=n}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.registerElement(),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof b?[new Ie(be.INVALID_TABLEGROUP_CONTEXT,"TableGroup must appear top-level",this.declarationNode)]:[]}validateName(e){return e?mt(e)?[]:[new Ie(be.INVALID_NAME,"A TableGroup name must be a single identifier",e)]:[new Ie(be.NAME_NOT_FOUND,"A TableGroup must have a name",this.declarationNode)]}validateAlias(e){return e?[new Ie(be.UNEXPECTED_ALIAS,"A TableGroup shouldn't have an alias",e)]:[]}registerElement(){const{name:e}=this.declarationNode;this.declarationNode.symbol=this.symbolFactory.create(ae,{declaration:this.declarationNode,symbolTable:new st});const t=Ye(e);if(t.isOk()){const n=t.unwrap(),i=n.pop(),s=Tt(n,this.publicSymbolTable,this.symbolFactory),a=q(i);if(s.has(a))return[new Ie(be.DUPLICATE_NAME,`TableGroup name '${i}' already exists`,e)];s.set(a,this.declarationNode.symbol)}return[]}validateSettingList(e){const t=wt(e),n=t.getErrors(),s=t.getValue();return i.forIn(s,((e,t)=>{switch(t){case"color":e.length>1&&n.push(...e.map((e=>new Ie(be.DUPLICATE_TABLE_SETTING,"'color' can only appear once",e)))),e.forEach((e=>{It(e.value)||n.push(new Ie(be.INVALID_TABLE_SETTING,"'color' must be a color literal",e.value||e.name))}));break;case"note":e.length>1&&n.push(...e.map((e=>new Ie(be.DUPLICATE_TABLE_SETTING,"'note' can only appear once",e)))),e.filter((e=>!Ce(e.value))).forEach((e=>{n.push(new Ie(be.INVALID_TABLE_SETTING,"'note' must be a string literal",e.value||e.name))}));break;default:n.push(...e.map((e=>new Ie(be.INVALID_TABLE_SETTING,`Unknown '${t}' setting`,e))))}})),n}validateBody(e){if(!e)return[];if(e instanceof g)return[new Ie(be.UNEXPECTED_SIMPLE_BODY,"A TableGroup's body must be a block",e)];const[t,n]=i.partition(e.body,(e=>e instanceof g));return[...this.validateFields(t),...this.validateSubElements(n)]}validateFields(e){return e.flatMap((e=>{const t=[];return e.callee&&!Ye(e.callee).isOk()&&t.push(new Ie(be.INVALID_TABLEGROUP_FIELD,"A TableGroup field must be of the form <table> or <schema>.<table>",e.callee)),this.registerField(e),e.args.length>0&&t.push(...e.args.map((e=>new Ie(be.INVALID_TABLEGROUP_FIELD,"A TableGroup field should only have a single Table name",e)))),t}))}validateSubElements(e){const t=e.flatMap((e=>{if(e.parent=this.declarationNode,!e.type)return[];return new(Nt(e))(e,this.publicSymbolTable,this.symbolFactory).validate()})),n=e.filter((e=>{var t;return"note"===(null==(t=e.type)?void 0:t.value.toLowerCase())}));return n.length>1&&t.push(...n.map((e=>new Ie(be.NOTE_REDEFINED,"Duplicate notes are defined",e)))),t}registerField(e){if(e.callee&&ke(e.callee)){const t=Je(e.callee).unwrap(),n=Y(t),i=this.symbolFactory.create(re,{declaration:e});e.symbol=i;const s=this.declarationNode.symbol.symbolTable;if(s.has(n)){const i=s.get(n);return[new Ie(be.DUPLICATE_TABLEGROUP_FIELD_NAME,`${t} already exists in the group`,e),new Ie(be.DUPLICATE_TABLEGROUP_FIELD_NAME,`${t} already exists in the group`,i.declaration)]}s.set(n,i)}return[]}}const pt=["-","+"];class Et{constructor(e,t,n){this.declarationNode=e,this.symbolFactory=n,this.publicSymbolTable=t}validate(){return[...this.validateContext(),...this.validateName(this.declarationNode.name),...this.validateAlias(this.declarationNode.alias),...this.validateSettingList(this.declarationNode.attributeList),...this.registerElement(),...this.validateBody(this.declarationNode.body)]}validateContext(){return this.declarationNode.parent instanceof b?[new Ie(be.INVALID_TABLE_PARTIAL_CONTEXT,"TablePartial must appear top-level",this.declarationNode)]:[]}validateName(e){return e?mt(e)?[]:[new Ie(be.INVALID_NAME,"A TablePartial name must be an identifier or a quoted identifer",e)]:[new Ie(be.NAME_NOT_FOUND,"A TablePartial must have a name",this.declarationNode)]}validateAlias(e){return e?[new Ie(be.UNEXPECTED_ALIAS,"A TablePartial shouldn't have an alias",e)]:[]}validateSettingList(e){const t=wt(e),n=t.getErrors(),s=t.getValue();return i.forIn(s,((e,t)=>{switch(t){case je.HeaderColor:e.length>1&&n.push(...e.map((e=>new Ie(be.DUPLICATE_TABLE_PARTIAL_SETTING,`'${t}' can only appear once`,e)))),e.forEach((e=>{It(e.value)||n.push(new Ie(be.INVALID_TABLE_PARTIAL_SETTING,`'${t}' must be a color literal`,e.value||e.name))}));break;case je.Note:e.length>1&&n.push(...e.map((e=>new Ie(be.DUPLICATE_TABLE_PARTIAL_SETTING,`'${t}' can only appear once`,e)))),e.forEach((e=>{Ce(e.value)||n.push(new Ie(be.INVALID_TABLE_PARTIAL_SETTING,`'${t}' must be a string literal`,e.value||e.name))}));break;default:n.push(...e.map((e=>new Ie(be.INVALID_TABLE_SETTING,`Unknown '${t}' setting`,e))))}})),n}registerElement(){const{name:e}=this.declarationNode;this.declarationNode.symbol=this.symbolFactory.create(oe,{declaration:this.declarationNode,symbolTable:new st});const t=Ye(e);if(!t.isOk())return[];const n=t.unwrap(),i=n.pop(),s=Tt(n,this.publicSymbolTable,this.symbolFactory),a=H(i);return s.has(a)?[new Ie(be.DUPLICATE_NAME,`TablePartial name '${i}' already exists`,e)]:(s.set(a,this.declarationNode.symbol),[])}validateBody(e){if(!e)return[];if(e instanceof g)return[new Ie(be.UNEXPECTED_SIMPLE_BODY,"A TablePartial's body must be a block",e)];const[t,n]=i.partition(e.body,(e=>e instanceof g));return[...this.validateFields(t),...this.validateSubElements(n)]}validateFields(e){return e.flatMap((e=>{if(!e.callee)return[];const t=[];0===e.args.length&&t.push(new Ie(be.INVALID_COLUMN,"A column must have a type",e.callee)),ke(e.callee)||t.push(new Ie(be.INVALID_COLUMN_NAME,"A column name must be an identifier or a quoted identifier",e.callee)),e.args[0]&&!gt(e.args[0])&&t.push(new Ie(be.INVALID_COLUMN_TYPE,"Invalid column type",e.args[0]));const n=e.args.slice(1);return t.push(...this.validateFieldSetting(n),...this.registerField(e)),t}))}registerField(e){if(!e.callee||!ke(e.callee))return[];const t=Je(e.callee).unwrap(),n=$(t),i=this.symbolFactory.create(se,{declaration:e});e.symbol=i;const s=this.declarationNode.symbol.symbolTable;if(s.has(n)){const i=s.get(n);return[new Ie(be.DUPLICATE_COLUMN_NAME,`Duplicate column ${t}`,e),new Ie(be.DUPLICATE_COLUMN_NAME,`Duplicate column ${t}`,i.declaration)]}return s.set(n,i),[]}validateFieldSetting(e){const t=i.last(e);if(!e.slice(0,-1).every(Se)||!(Se(t)||t instanceof k))return[...e.map((e=>new Ie(be.INVALID_COLUMN,"These fields must be some inline settings optionally ended with a setting list",e)))];if(0===e.length)return[];let n;i.last(e)instanceof k&&(n=e.pop());const s=wt(n),a=s.getErrors(),r=s.getValue();e.forEach((e=>{const t=Je(e).unwrap_or("").toLowerCase();t===je.PK||t===je.Unique?void 0===r[t]?r[t]=[e]:r[t].push(e):a.push(new Ie(be.INVALID_SETTINGS,"Inline column settings can only be `pk` or `unique`",e))}));const o=r[je.PK]||[],l=r[je.PKey]||[];return o.length>=1&&l.length>=1&&a.push(...[...o,...l].map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,"Either one of 'primary key' and 'pk' can appear",e)))),i.forIn(r,((e,t)=>{switch(t){case je.Note:e.length>1&&a.push(...e.map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,`'${t}' can only appear once`,e)))),e.forEach((e=>{Ce(e.value)||a.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,`'${t}' must be a quoted string`,e.value||e.name))}));break;case je.Ref:e.forEach((e=>{At(e.value)||a.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,`'${t}' must be a valid unary relationship`,e.value||e.name))}));break;case je.PKey:e.length>1&&a.push(...e.map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,`'${t}' can only appear once`,e)))),e.forEach((e=>{vt(e.value)||a.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,`'${t}' must not have a value`,e.value||e.name))}));break;case je.PK:e.length>1&&a.push(...e.map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,`'${t}' can only appear once`,e)))),e.forEach((e=>{e instanceof v&&!vt(e.value)&&a.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,`'${t}' must not have a value`,e.value||e.name))}));break;case je.NotNull:{e.length>1&&a.push(...e.map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,`'${t}' can only appear once`,e))));const n=r[je.Null]||[];e.length>=1&&n.length>=1&&a.push(...[...e,...n].map((e=>new Ie(be.CONFLICTING_SETTING,"'not null' and 'null' can not be set at the same time",e)))),e.forEach((e=>{vt(e.value)||a.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,`'${t}' must not have a value`,e.value||e.name))}));break}case je.Null:e.length>1&&a.push(...e.map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,`'${t}' can only appear once`,e)))),e.forEach((e=>{vt(e.value)||a.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,`'${t}' must not have a value`,e.value||e.name))}));break;case je.Unique:case je.Increment:e.length>1&&a.push(...e.map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,`'${t}' can only appear once`,e)))),e.forEach((e=>{e instanceof v&&!vt(e.value)&&a.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,`'${t}' must not have a value`,e.value||e.name))}));break;case je.Default:e.length>1&&a.push(...e.map((e=>new Ie(be.DUPLICATE_COLUMN_SETTING,`'${t}' can only appear once`,e)))),e.forEach((e=>{Lt(e.value)||a.push(new Ie(be.INVALID_COLUMN_SETTING_VALUE,`'${t}' must be a string literal, number literal, function expression, true, false or null`,e.value||e.name))}));break;default:e.forEach((e=>a.push(new Ie(be.UNKNOWN_COLUMN_SETTING,`Unknown column setting '${t}'`,e))))}})),a}validateSubElements(e){const t=e.flatMap((e=>{if(e.parent=this.declarationNode,!e.type)return[];return new(Nt(e))(e,this.publicSymbolTable,this.symbolFactory).validate()})),n=e.filter((e=>{var t;return(null==(t=e.type)?void 0:t.value.toLowerCase())===$e.Note}));return n.length>1&&t.push(...n.map((e=>new Ie(be.NOTE_REDEFINED,"Duplicate notes are defined",e)))),t}}function Nt(e){switch(e.type.value.toLowerCase()){case $e.Enum:return at;case $e.Table:return ht;case $e.TableGroup:return dt;case $e.Project:return lt;case $e.Ref:return ct;case $e.Note:return ot;case $e.Indexes:return rt;case $e.TablePartial:return Et;default:return it}}function ft(e){return!!Ye(e).unwrap_or(!1)}function mt(e){return e instanceof R&&e.expression instanceof x}function Tt(e,t,n){var i;"public"===e[0]&&(e=e.slice(1));let s=t;for(const t of e){let e;const a=X(t);if(s.has(a)){if(e=null==(i=s.get(a))?void 0:i.symbolTable,!e)throw new Error("Expect a symbol table in a schema symbol")}else{e=new st;const t=n.create(ee,{symbolTable:e});s.set(a,t)}s=e}return s}function bt(e){return"-"===e||"<>"===e||">"===e||"<"===e}function It(e){var t;if(!(e instanceof R&&e.expression instanceof O&&(null==(t=e.expression.literal)?void 0:t.kind)===a.COLOR_LITERAL))return!1;const n=e.expression.literal.value;if(4!==n.length&&7!==n.length||"#"!==n[0])return!1;for(let e=1;e<n.length;e+=1)if(!pe(n[e]))return!1;return!0}function vt(e){return void 0===e}function Lt(e){var t;return!!(Ce(e)||_t(e)||Se(e)&&["true","false","null"].includes(e.expression.variable.value.toLowerCase())||e instanceof L&&pt.includes(null==(t=e.op)?void 0:t.value)&&_t(e.expression)||e instanceof y)}function _t(e){var t,n,i;return e instanceof L?("-"===(null==(t=e.op)?void 0:t.value)||"+"===(null==(n=e.op)?void 0:n.value))&&_t(e.expression):e instanceof R&&e.expression instanceof O&&(null==(i=e.expression.literal)?void 0:i.kind)===a.NUMERIC_LITERAL}function At(e){var t;if(!(e instanceof L&&bt(null==(t=e.op)?void 0:t.value)))return!1;const n=Ye(e.expression).unwrap_or(void 0);return void 0!==n&&n.length>0}function yt(e){return e instanceof S&&e.elementList.every(ke)}function gt(e){if(!(e instanceof D||Pe(e)||e instanceof R||e instanceof M))return!1;if(e instanceof D){if(void 0===e.callee||void 0===e.argumentList||!e.argumentList.elementList.every((e=>_t(e)||Ce(e)||Se(e))))return!1;e=e.callee}for(;e instanceof M;){if(void 0===e.array||void 0===e.indexer||!e.indexer.elementList.every((e=>!e.colon&&!e.value&&_t(e.name))))return!1;e=e.array}const t=Ye(e).unwrap_or(void 0);return void 0!==t&&t.length>0}function wt(e){var t;const n={},i=[];if(!e)return new ve({});for(const s of e.elementList){if(!s.name)continue;if(s.name instanceof R){i.push(new Ie(be.INVALID_SETTINGS,"A setting name must be a stream of identifiers",s.name));continue}const e=null==(t=De(s.name).unwrap_or(void 0))?void 0:t.toLowerCase();e&&(void 0===n[e]?n[e]=[s]:n[e].push(s))}return new ve(n,i)}class Ct{constructor(e,t){this.ast=e,this.symbolFactory=t,this.publicSchemaSymbol=this.symbolFactory.create(ee,{symbolTable:new st}),this.ast.symbol=this.publicSchemaSymbol,this.ast.symbol.declaration=this.ast}validate(){const e=[];this.ast.body.forEach((t=>{if(t.parent=this.ast,void 0===t.type)return;const n=new(Nt(t))(t,this.publicSchemaSymbol.symbolTable,this.symbolFactory);e.push(...n.validate())}));const t=this.ast.body.filter((e=>We(e).unwrap_or(void 0)===$e.Project));return t.length>1&&t.forEach((t=>e.push(new Ie(be.PROJECT_REDEFINED,"Only one project can exist",t)))),new ve(this.ast,e)}}class kt{constructor(e,t){this.declarationNode=e,this.errors=t}bind(){this.bindSettingList(this.declarationNode.attributeList,this.settingList),this.bindBody()}bindSettingList(e,t){e&&e.elementList.forEach((e=>{if(e.name instanceof R)return;const n=De(e.name).unwrap_or(void 0);if(!n)return;const i=t[n.toLowerCase()];null!=i&&i.shouldBind&&this.scanAndBind(e.value,i)}))}bindBody(){const e=this.declarationNode;if(!e.body)return;const{body:t}=e;t instanceof w?t.body.forEach((e=>{if(e instanceof b){if(!e.type||We(this.declarationNode).unwrap_or(null)===$e.TablePartial&&We(e).unwrap_or(null)===$e.Indexes)return;new(Bt(e))(e,this.errors).bind()}else e instanceof g?this.bindSubfield(e):this.bindPartialInjection(e)})):this.bindSubfield(t)}bindSubfield(e){const t=[e.callee,...e.args],n=i.last(t);n instanceof k&&(t.pop(),this.bindSettingList(n,this.subfield.settingList));const{argBinderRules:s}=this.subfield.arg;for(let e=0;e<Math.min(t.length,s.length);e+=1)s[e].shouldBind&&this.scanAndBind(t[e],s[e])}bindPartialInjection(e){var t;null!=(t=this.injectionBinderRule)&&t.shouldBind&&this.scanAndBind(e,this.injectionBinderRule)}scanAndBind(e,t){var n,i;if(e)if(e instanceof R){if(e.expression instanceof x&&null!=(i=t.keywords)&&i.includes(null==(n=e.expression.variable)?void 0:n.value.toLowerCase()))return;this.bindFragments([e],t)}else e instanceof _?Pe(e)?this.bindFragments(qe(e).unwrap_or([]),t):(this.scanAndBind(e.leftExpression,t),this.scanAndBind(e.rightExpression,t)):e instanceof L||e instanceof A?this.scanAndBind(e.expression,t):e instanceof S?e.elementList.forEach((e=>this.scanAndBind(e,t))):e instanceof C&&this.bindFragments([e],t)}bindFragments(e,t){if(0===e.length)return;const n=1===e.length&&e[0]instanceof C,i=[...t.topSubnamesSymbolKind],{remainingSubnamesSymbolKind:s}=t,a=n?-1:e.findIndex((e=>!ke(e))),r=-1!==a&&yt(e[a])?e[a]:void 0,o=a>=0?i.pop():void 0,l=e.slice(0,-1===a?void 0:a);if(0===l.length)return;const c=[];for(;i.length&&l.length;){const e=i.pop(),t=l.pop(),n=Je(t).unwrap();c.unshift({index:Q(n,e),referrer:t})}for(;l.length;){const e=l.pop(),t=n?Ze(e).unwrap():Je(e).unwrap();c.unshift({index:Q(t,s),referrer:e})}return r?r.elementList.forEach((e=>this.resolveIndexStack([...c,{index:Q(Je(e).unwrap(),o),referrer:e}],t.ignoreNameNotFound))):this.resolveIndexStack(c,t.ignoreNameNotFound)}resolveIndexStack(e,t){if(0===e.length)throw new Error("Unreachable - An unresolved name must have at least one name component");const[n,...i]=e,s=nt(n.index,this.declarationNode);if(void 0===s){const{kind:e,name:i}=J(n.index).unwrap();return void this.logError(n.referrer,`Can not find ${e} '${i}'`,t)}s.references.push(n.referrer),n.referrer.referee=s;let a=s.symbolTable,{kind:r,name:o}=J(n.index).unwrap();for(const e of i){const{kind:n,name:i}=J(e.index).unwrap(),s=a.get(e.index);if(!s)return void this.logError(e.referrer,`${r} '${o}' does not have ${n} '${i}'`,t);if(r=n,o=i,e.referrer.referee=s,s.references.push(e.referrer),!s.symbolTable)break;a=s.symbolTable}}logError(e,t,n){n||this.errors.push(new Ie(be.BINDING_ERROR,t,e))}resolveInjections(e){var t;const n=null==(t=this.declarationNode.symbol)?void 0:t.symbolTable;if(!n)return;const i=new Map;n.forEach(((e,t)=>{var s,a;if(!function(e){const t=J(e).unwrap_or(void 0);if(!t)return!1;const{kind:n}=t;return"TablePartialInjection"===n}(t))return;const r=nt(function(e){const t=J(e).unwrap_or(void 0);if(!t)return null;const{kind:n,name:i}=t;return"TablePartialInjection"===n?Q(i,"TablePartial"):null}(t),this.declarationNode),o=null==(a=null==(s=null==r?void 0:r.declaration)?void 0:s.symbol)?void 0:a.symbolTable;o&&o.forEach(((t,s)=>{n.has(s)||i.set(s,{injectorFieldSymbol:t,injectorDeclaration:e.declaration})}))})),i.forEach(((t,i)=>{const s=function(e){return e instanceof se?ce:null}(t.injectorFieldSymbol);if(!s)return;const a=e.create(s,t);n.set(i,a)}))}}class St extends kt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[]},settingList:{}},this.settingList={}}}class Pt extends kt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[{shouldBind:!1}]},settingList:{}},this.settingList={}}}class Dt extends kt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[{shouldBind:!0,topSubnamesSymbolKind:[G.Table,G.Column],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!1},{shouldBind:!0,topSubnamesSymbolKind:[G.Table,G.Column],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!1},{shouldBind:!0,topSubnamesSymbolKind:[G.Table,G.Column],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!1},{shouldBind:!0,topSubnamesSymbolKind:[G.Table,G.Column],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!1}]},settingList:{}},this.settingList={}}}class Ot extends kt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[{shouldBind:!1}]},settingList:{}},this.settingList={}}}class xt extends kt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[]},settingList:{}},this.settingList={}}}class Rt extends kt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[{shouldBind:!0,topSubnamesSymbolKind:[G.Table,G.Column],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!1}]},settingList:{}},this.settingList={}}}class Ut extends kt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[{shouldBind:!1},{shouldBind:!0,topSubnamesSymbolKind:[G.Enum],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!0}]},settingList:{ref:{shouldBind:!0,topSubnamesSymbolKind:[G.Table,G.Column],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!1},default:{shouldBind:!1}}},this.settingList={},this.injectionBinderRule={shouldBind:!0,topSubnamesSymbolKind:[],remainingSubnamesSymbolKind:G.TablePartial,ignoreNameNotFound:!1}}}class Mt extends kt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[{shouldBind:!0,topSubnamesSymbolKind:[G.Table],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!1}]},settingList:{}},this.settingList={}}}class Ft extends kt{constructor(){super(...arguments),this.subfield={arg:{argBinderRules:[{shouldBind:!1},{shouldBind:!0,topSubnamesSymbolKind:[G.Enum],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!0}]},settingList:{ref:{shouldBind:!0,topSubnamesSymbolKind:[G.Table,G.Column],remainingSubnamesSymbolKind:G.Schema,ignoreNameNotFound:!1},default:{shouldBind:!1}}},this.settingList={}}}function Bt(e){switch(e.type.value.toLowerCase()){case $e.Enum:return Pt;case $e.Table:return Ut;case $e.TableGroup:return Mt;case $e.Project:return xt;case $e.Ref:return Rt;case $e.Note:return Ot;case $e.Indexes:return Dt;case $e.TablePartial:return Ft;default:return St}}class Vt{constructor(e){this.ast=e,this.errors=[]}resolve(e){return this.ast.body.map((t=>{if(!t.type)return null;const n=new(Bt(t))(t,this.errors);return n.resolveInjections(e),n})).forEach((e=>null==e?void 0:e.bind())),new ve(this.ast,this.errors)}}class Gt{constructor(e){this.generator=e}create(e,t){return new e(t,this.generator.nextId())}}class Xt{constructor(e,t){this.ast=e,this.symbolFactory=new Gt(t)}analyze(){return new Ct(this.ast,this.symbolFactory).validate().chain((e=>new Vt(e).resolve(this.symbolFactory)))}validate(){return new Ct(this.ast,this.symbolFactory).validate().chain((e=>new ve(e,[])))}}function Kt(e,t){const{variables:n,tupleElements:i}=He(e).unwrap();return i?0===n.length?{schemaName:t.schemaName,tableName:t.name,fieldNames:i}:{tableName:n.pop(),schemaName:n.pop()||null,fieldNames:i}:1===n.length?{schemaName:t.schemaName,tableName:t.name,fieldNames:[n[0]]}:{fieldNames:[n.pop()],tableName:n.pop(),schemaName:n.pop()||null}}function $t(e){switch(e){case"<":return["1","*"];case"<>":return["*","*"];case">":return["*","1"];case"-":return["1","1"];default:throw new Error("Invalid relation op")}}function jt(e){return{start:{offset:e.startPos.offset,line:e.startPos.line+1,column:e.startPos.column+1},end:{offset:e.endPos.offset,line:e.endPos.line+1,column:e.endPos.column+1}}}function Wt(e){var t;const n=null==(t=qe(e).unwrap_or(void 0))?void 0:t.pop();return n instanceof S?n.elementList.map((e=>e.referee)):[n.referee]}function qt(e){const t=Ye(e).unwrap();return{name:t.pop(),schemaName:t}}function Yt(e){return e.expression.literal.value}function Ht(e,t){if(Array.isArray(e)){const n=e.map((({id:e})=>e)).sort().join(","),i=t.map((({id:e})=>e)).sort().join(",");return n<i?`${n}-${i}`:`${i}-${n}`}const n=e.id.toString(),i=t.id.toString();return n<i?`${n}-${i}`:`${i}-${n}`}function zt(e,t){if(Array.isArray(e)){const n=e.map((({id:e})=>e)).sort(),s=t.map((({id:e})=>e)).sort();return i.zip(n,s).every((([e,t])=>e===t))}return e.id===t.id}function Qt(e){const t=e.split("\n"),n=t.slice(t.findIndex((e=>""!==e.trimStart()))),i=n.filter((e=>e.trimStart())),s=Math.min(...i.map((e=>e.length-e.trimStart().length)));return n.map((e=>e.slice(s))).join("\n")}function Jt(e){if(e){if(Ce(e))return{value:et(e).unwrap(),type:"string"};if(_t(e))return{type:"number",value:Te(e)};if(Se(e))return{value:e.expression.variable.value.toLowerCase(),type:"boolean"};if(e instanceof y&&e.value)return{value:e.value.value,type:"expression"};throw new Error("Unreachable")}}function Zt(e){let t=null;e instanceof D&&(t=e.argumentList.elementList.map((e=>_t(e)?me(e):Ce(e)?et(e).unwrap():ze(e).unwrap())).join(","),e=e.callee);let n="";for(;e instanceof M;)n=`[${e.indexer.elementList.map((e=>e.name.expression.literal.value)).join(",")}]${n}`,e=e.array;const{name:i,schemaName:s}=qt(e);return s.length>1?new ve({schemaName:0===s.length?null:s[0],type_name:`${i}${n}${t?`(${t})`:""}`,args:t},[new Ie(be.UNSUPPORTED,"Nested schema is not supported",e)]):new ve({schemaName:0===s.length?null:s[0],type_name:`${i}${n}${t?`(${t})`:""}`,args:t})}class en{constructor(e,t){this.declarationNode=e,this.env=t,this.table={name:void 0,schemaName:void 0,alias:null,fields:[],token:void 0,indexes:[],partials:[]},this.pkColumns=[]}interpret(){this.table.token=jt(this.declarationNode),this.env.tables.set(this.declarationNode,this.table);const e=[...this.interpretName(this.declarationNode.name),...this.interpretAlias(this.declarationNode.alias),...this.interpretSettingList(this.declarationNode.attributeList),...this.interpretBody(this.declarationNode.body)];return this.pkColumns.length>=2&&(this.table.indexes.push({columns:this.pkColumns.map((({name:e,token:t})=>({value:e,type:"column",token:t}))),token:{start:{offset:-1,line:-1,column:-1},end:{offset:-1,line:-1,column:-1}},pk:!0}),this.pkColumns.forEach((e=>{e.pk=!1}))),e}interpretName(e){const{name:t,schemaName:n}=qt(e);return n.length>1?(this.table.name=t,this.table.schemaName=n.join("."),[new Ie(be.UNSUPPORTED,"Nested schema is not supported",e)]):(this.table.name=t,this.table.schemaName=n.length?n[0]:null,[])}interpretAlias(e){if(!e)return[];const t=Je(e).unwrap_or(null);return t&&(this.env.aliases.push({name:t,kind:"table",value:{tableName:this.table.name,schemaName:this.table.schemaName}}),this.table.alias=t),[]}interpretSettingList(e){var t,n,i;const s=wt(e).getValue();this.table.headerColor=null!=(t=s[je.HeaderColor])&&t.length?Yt(null==(i=null==(n=s[je.HeaderColor])?void 0:n.at(0))?void 0:i.value):void 0;const[a]=s[je.Note]||[];return this.table.note=a&&{value:et(null==a?void 0:a.value).map(Qt).unwrap(),token:jt(a)},[]}interpretBody(e){const[t,n]=i.partition(e.body,(e=>e instanceof g||e instanceof C));return[...this.interpretFields(t),...this.interpretSubElements(n)]}interpretSubElements(e){return e.flatMap((e=>{var t;switch(null==(t=e.type)?void 0:t.value.toLowerCase()){case $e.Note:return this.table.note={value:et(e.body instanceof w?e.body.body[0].callee:e.body.callee).map(Qt).unwrap(),token:jt(e)},[];case $e.Indexes:return this.interpretIndexes(e);default:return[]}}))}interpretInjection(e,t){const n={order:t,token:jt(e)};return n.name=e.partial.variable.value,this.table.partials.push(n),[]}interpretFields(e){var t;return[...(null!=(t=this.declarationNode.symbol)&&t.symbolTable?[...this.declarationNode.symbol.symbolTable.entries()]:[]).filter((([e])=>{const t=J(e).unwrap_or(null);return(null==t?void 0:t.kind)===G.Column})).length?[]:[new Ie(be.EMPTY_TABLE,"A Table must have at least one column",this.declarationNode)],...e.flatMap(((e,t)=>e instanceof g?this.interpretColumn(e):this.interpretInjection(e,t)))]}interpretColumn(e){var t,n,s,a,r,o,l,c,u;const h=[],d={};d.name=Je(e.callee).unwrap();const p=Zt(e.args[0]);d.type=p.getValue(),h.push(...p.getErrors()),d.token=jt(e),d.inline_refs=[];const E=e.args.slice(1);if(i.last(E)instanceof k){const i=wt(E.pop()).getValue();d.pk=!(null==(t=i[je.PK])||!t.length)||!(null==(n=i[je.PKey])||!n.length),d.increment=!(null==(s=i[je.Increment])||!s.length),d.unique=!(null==(a=i[je.Unique])||!a.length),d.not_null=!(null==(r=i[je.NotNull])||!r.length)||(null==(o=i[je.Null])||!o.length)&&void 0,d.dbdefault=Jt(null==(c=null==(l=i[je.Default])?void 0:l.at(0))?void 0:c.value);const p=null==(u=i[je.Note])?void 0:u.at(0);d.note=p&&{value:et(p.value).map(Qt).unwrap(),token:jt(p)};const N=i[je.Ref]||[];d.inline_refs=N.flatMap((t=>{const[n]=Wt(t.value.expression);if(zt(n,e.symbol))return h.push(new Ie(be.SAME_ENDPOINT,"Two endpoints are the same",t)),[];const i=t.value.op,s=Ye(t.value.expression).unwrap();let a;if(1===s.length){const[e]=s;a={schemaName:this.table.schemaName,tableName:this.table.name,fieldNames:[e],relation:i.value,token:jt(t)}}else if(2===s.length){const[e,n]=s;a={schemaName:null,tableName:e,fieldNames:[n],relation:i.value,token:jt(t)}}else if(3===s.length){const[e,n,r]=s;a={schemaName:e,tableName:n,fieldNames:[r],relation:i.value,token:jt(t)}}else{h.push(new Ie(be.UNSUPPORTED,"Nested schema is not supported",t));const e=s.pop(),n=s.pop();a={schemaName:s.join("."),tableName:n,fieldNames:[e],relation:i.value,token:jt(t)}}const r=this.registerInlineRefToEnv(e,n,a,t);return h.push(...r),0===r.length?a:[]}))}return d.pk||(d.pk=E.some((e=>"pk"===ze(e).unwrap().toLowerCase()))),d.unique||(d.unique=E.some((e=>"unique"===ze(e).unwrap().toLowerCase()))),this.table.fields.push(d),d.pk&&this.pkColumns.push(d),h}interpretIndexes(e){return this.table.indexes.push(...e.body.body.map((e=>{var t,n,s,a,r,o,l;const c={columns:[]},u=e;c.token=jt(u);const h=[u.callee,...u.args];if(i.last(h)instanceof k){const e=wt(h.pop()).getValue();c.pk=!(null==(t=e[je.PK])||!t.length),c.unique=!(null==(n=e[je.Unique])||!n.length),c.name=et(null==(a=null==(s=e[je.Name])?void 0:s.at(0))?void 0:a.value).unwrap_or(void 0);const i=null==(r=e[je.Note])?void 0:r.at(0);c.note=i&&{value:et(i.value).unwrap(),token:jt(i)},c.type=ze(null==(l=null==(o=e[je.Type])?void 0:o.at(0))?void 0:l.value).unwrap_or(void 0)}return h.flatMap((e=>{if(!(e instanceof D))return e;const t=[];for(;e instanceof D;)t.push(e.argumentList),e=e.callee;return t.push(e),t})).forEach((e=>{const{functional:t,nonFunctional:n}=Qe(e).unwrap();c.columns.push(...t.map((e=>({value:e.value.value,type:"expression",token:jt(e)}))),...n.map((e=>({value:Je(e).unwrap(),type:"column",token:jt(e)}))))})),c}))),[]}registerInlineRefToEnv(e,t,n,i){const s=Ht(e.symbol,t);if(this.env.refIds[s])return[new Ie(be.CIRCULAR_REF,"References with same endpoints exist",i),new Ie(be.CIRCULAR_REF,"References with same endpoints exist",this.env.refIds[s])];const a=$t(n.relation);return this.env.refIds[s]=i,this.env.ref.set(i,{name:null,schemaName:null,token:n.token,endpoints:[{...n,relation:a[1]},{schemaName:this.table.schemaName,tableName:this.table.name,fieldNames:[ze(e.callee).unwrap()],token:jt(e),relation:a[0]}]}),[]}}class tn{constructor(e,t){this.declarationNode=e,this.env=t,this.note={name:void 0,content:void 0,token:void 0}}interpret(){return this.note.token=jt(this.declarationNode),this.env.notes.set(this.declarationNode,this.note),[...this.interpretName(this.declarationNode.name),...this.interpretSettingList(this.declarationNode.attributeList),...this.interpretBody(this.declarationNode.body)]}interpretName(e){const{name:t}=qt(e);return this.note.name=t,[]}interpretSettingList(e){var t,n,i;const s=wt(e).getValue();return this.note.headerColor=null!=(t=s.headercolor)&&t.length?Yt(null==(i=null==(n=s.headercolor)?void 0:n.at(0))?void 0:i.value):void 0,[]}interpretBody(e){const[t,n]=i.partition(e.body,(e=>e instanceof g));return 1!==t.length||n.length>0?[new Ie(be.INVALID_NOTE,"Invalid note syntax",e)]:[...this.interpretNote(t[0])]}interpretNote(e){const t=i.get(e,"callee.expression.literal.value","");return this.note.content=Qt(t),[]}}class nn{constructor(e,t){this.declarationNode=e,this.env=t,this.container=this.declarationNode.parent instanceof b?this.env.tables.get(this.declarationNode.parent):void 0,this.ref={}}interpret(){return this.ref.token=jt(this.declarationNode),this.env.ref.set(this.declarationNode,this.ref),[...this.interpretName(this.declarationNode.name),...this.interpretBody(this.declarationNode.body)]}interpretName(e){const t=[],n=Ye(this.declarationNode.name).unwrap_or([]);return this.ref.name=n.pop()||null,n.length>1&&t.push(new Ie(be.UNSUPPORTED,"Nested schema is not supported",this.declarationNode.name)),this.ref.schemaName=n.join(".")||null,t}interpretBody(e){return e instanceof g?this.interpretField(e):this.interpretField(e.body[0])}interpretField(e){var t,n,i,s,a,r,o;const l=e.callee.op.value,{leftExpression:c,rightExpression:u}=e.callee,h=Wt(c),d=Wt(u);if(zt(h,d))return[new Ie(be.SAME_ENDPOINT,"Two endpoints are the same",e)];const p=Ht(h,d);if(this.env.refIds[p])return[new Ie(be.CIRCULAR_REF,"References with same endpoints exist",this.declarationNode),new Ie(be.CIRCULAR_REF,"References with same endpoints exist",this.env.refIds[p])];if(e.args[0]){const l=wt(e.args[0]).getValue(),c=null==(n=null==(t=l.delete)?void 0:t.at(0))?void 0:n.value;this.ref.onDelete=c instanceof I?De(c).unwrap_or(void 0):ze(c).unwrap_or(void 0);const u=null==(s=null==(i=l.update)?void 0:i.at(0))?void 0:s.value;this.ref.onUpdate=u instanceof I?De(u).unwrap_or(void 0):ze(u).unwrap_or(void 0),this.ref.color=null!=(a=l.color)&&a.length?Yt(null==(o=null==(r=l.color)?void 0:r.at(0))?void 0:o.value):void 0}const E=$t(l);return this.ref.endpoints=[{...Kt(c,this.container),relation:E[0],token:jt(c)},{...Kt(u,this.container),relation:E[1],token:jt(u)}],this.env.refIds[p]=this.declarationNode,[]}}class sn{constructor(e,t){this.declarationNode=e,this.env=t,this.tableGroup={tables:[]}}interpret(){const e=[];return this.tableGroup.token=jt(this.declarationNode),this.env.tableGroups.set(this.declarationNode,this.tableGroup),e.push(...this.interpretName(this.declarationNode.name),...this.interpretSettingList(this.declarationNode.attributeList),...this.interpretBody(this.declarationNode.body)),e}interpretName(e){const t=[],{name:n,schemaName:i}=qt(e);return i.length>=2&&(this.tableGroup.name=n,this.tableGroup.schemaName=i.join("."),t.push(new Ie(be.UNSUPPORTED,"Nested schema is not supported",this.declarationNode.name))),this.tableGroup.name=n,this.tableGroup.schemaName=i[0]||null,t}interpretBody(e){const[t,n]=i.partition(e.body,(e=>e instanceof g));return[...this.interpretFields(t),...this.interpretSubElements(n)]}interpretSubElements(e){return e.flatMap((e=>{var t;if("note"===(null==(t=e.type)?void 0:t.value.toLowerCase()))this.tableGroup.note={value:et(e.body instanceof w?e.body.body[0].callee:e.body.callee).map(Qt).unwrap(),token:jt(e)};return[]}))}interpretFields(e){const t=[];return this.tableGroup.tables=e.map((e=>{const n=Ye(e.callee).unwrap();n.length>2&&t.push(new Ie(be.UNSUPPORTED,"Nested schema is not supported",e));const i=qe(e.callee).unwrap().pop().referee.id;if(this.env.groupOfTable[i]){const s=this.env.groupOfTable[i],{schemaName:a,name:r}=this.env.tableGroups.get(s),o=a?`${a}.${r}`:r;t.push(new Ie(be.TABLE_REAPPEAR_IN_TABLEGROUP,`Table "${n.join(".")}" already appears in group "${o}"`,e))}else this.env.groupOfTable[i]=this.declarationNode;return{name:n.pop(),schemaName:n.join(".")}})),t}interpretSettingList(e){var t,n,i;const s=wt(e).getValue();this.tableGroup.color=null!=(t=s.color)&&t.length?Yt(null==(i=null==(n=s.color)?void 0:n.at(0))?void 0:i.value):void 0;const[a]=s.note||[];return this.tableGroup.note=a&&{value:et(null==a?void 0:a.value).map(Qt).unwrap(),token:jt(a)},[]}}class an{constructor(e,t){this.declarationNode=e,this.env=t,this.enum={values:[]}}interpret(){return this.enum.token=jt(this.declarationNode),this.env.enums.set(this.declarationNode,this.enum),[...this.interpretName(this.declarationNode.name),...this.interpretBody(this.declarationNode.body)]}interpretName(e){const{name:t,schemaName:n}=qt(e);return n.length>1?(this.enum.name=t,this.enum.schemaName=n.join("."),[new Ie(be.UNSUPPORTED,"Nested schema is not supported",e)]):(this.enum.name=t,this.enum.schemaName=n.length?n[0]:null,[])}interpretBody(e){return e.body.flatMap((e=>{var t;const n=e,i={};i.token=jt(n),i.name=ze(n.callee).unwrap();const s=null==(t=wt(n.args[0]).getValue().note)?void 0:t.at(0);return i.note=s&&{value:et(s.value).map(Qt).unwrap(),token:jt(s)},this.enum.values.push(i),[]}))}}class rn{constructor(e,t){this.declarationNode=e,this.env=t,this.tablePartial={name:void 0,fields:[],token:void 0,indexes:[]},this.pkColumns=[]}interpret(){this.tablePartial.token=jt(this.declarationNode),this.env.tablePartials.set(this.declarationNode,this.tablePartial);const e=[...this.interpretName(this.declarationNode.name),...this.interpretSettingList(this.declarationNode.attributeList),...this.interpretBody(this.declarationNode.body)];return this.pkColumns.length>=2&&(this.tablePartial.indexes.push({columns:this.pkColumns.map((({name:e,token:t})=>({value:e,type:"column",token:t}))),token:{start:{offset:-1,line:-1,column:-1},end:{offset:-1,line:-1,column:-1}},pk:!0}),this.pkColumns.forEach((e=>{e.pk=!1}))),e}interpretName(e){const{name:t}=qt(e);return this.tablePartial.name=t,[]}interpretSettingList(e){const t=wt(e).getValue(),n=i.head(t[je.HeaderColor]);this.tablePartial.headerColor=n?Yt(n.value):void 0;const[s]=t[je.Note]||[];return this.tablePartial.note=s&&{value:et(null==s?void 0:s.value).map(Qt).unwrap(),token:jt(s)},[]}interpretBody(e){const[t,n]=i.partition(e.body,(e=>e instanceof g));return[...this.interpretFields(t),...this.interpretSubElements(n)]}interpretSubElements(e){return e.flatMap((e=>{var t;switch(null==(t=e.type)?void 0:t.value.toLowerCase()){case $e.Note:return this.tablePartial.note={value:et(e.body instanceof w?e.body.body[0].callee:e.body.callee).map(Qt).unwrap(),token:jt(e)},[];case $e.Indexes:return this.interpretIndexes(e);default:return[]}}))}interpretFields(e){return e.flatMap((e=>this.interpretColumn(e)))}interpretColumn(e){var t,n,s,a,r,o,l,c,u;const h=[],d={};d.name=Je(e.callee).unwrap();const p=Zt(e.args[0]);d.type=p.getValue(),h.push(...p.getErrors()),d.token=jt(e),d.inline_refs=[];const E=e.args.slice(1);if(i.last(E)instanceof k){const i=wt(E.pop()).getValue();d.pk=!(null==(t=i[je.PK])||!t.length)||!(null==(n=i[je.PKey])||!n.length),d.increment=!(null==(s=i[je.Increment])||!s.length),d.unique=!(null==(a=i[je.Unique])||!a.length),d.not_null=!(null==(r=i[je.NotNull])||!r.length)||(null==(o=i[je.Null])||!o.length)&&void 0,d.dbdefault=Jt(null==(c=null==(l=i[je.Default])?void 0:l.at(0))?void 0:c.value);const p=null==(u=i[je.Note])?void 0:u.at(0);d.note=p&&{value:et(p.value).map(Qt).unwrap(),token:jt(p)};const N=i[je.Ref]||[];d.inline_refs=N.flatMap((t=>{const[n]=Wt(t.value.expression);if(zt(n,e.symbol))return h.push(new Ie(be.SAME_ENDPOINT,"Two endpoints are the same",t)),[];const i=t.value.op,s=Ye(t.value.expression).unwrap();let a;if(2===s.length){const[e,n]=s;a={schemaName:null,tableName:e,fieldNames:[n],relation:i.value,token:jt(t)}}else if(3===s.length){const[e,n,r]=s;a={schemaName:e,tableName:n,fieldNames:[r],relation:i.value,token:jt(t)}}else{h.push(new Ie(be.UNSUPPORTED,"Unsupported",t));const e=s.pop(),n=s.pop();a={schemaName:s.join("."),tableName:n,fieldNames:[e],relation:i.value,token:jt(t)}}return a}))}return d.pk||(d.pk=E.some((e=>"pk"===ze(e).unwrap().toLowerCase()))),d.unique||(d.unique=E.some((e=>"unique"===ze(e).unwrap().toLowerCase()))),this.tablePartial.fields.push(d),d.pk&&this.pkColumns.push(d),h}interpretIndexes(e){return this.tablePartial.indexes.push(...e.body.body.map((e=>{var t,n,s,a,r,o,l;const c={columns:[]},u=e;c.token=jt(u);const h=[u.callee,...u.args];if(i.last(h)instanceof k){const e=wt(h.pop()).getValue();c.pk=!(null==(t=e[je.PK])||!t.length),c.unique=!(null==(n=e[je.Unique])||!n.length),c.name=et(null==(a=null==(s=e[je.Name])?void 0:s.at(0))?void 0:a.value).unwrap_or(void 0);const i=null==(r=e[je.Note])?void 0:r.at(0);c.note=i&&{value:et(i.value).unwrap(),token:jt(i)},c.type=ze(null==(l=null==(o=e[je.Type])?void 0:o.at(0))?void 0:l.value).unwrap_or(void 0)}return h.flatMap((e=>{if(!(e instanceof D))return e;const t=[];let n=e;for(;n instanceof D;)t.push(n.argumentList),n=n.callee;return t.push(n),t})).forEach((e=>{const{functional:t,nonFunctional:n}=Qe(e).unwrap();c.columns.push(...t.map((e=>({value:e.value.value,type:"expression",token:jt(e)}))),...n.map((e=>({value:Je(e).unwrap(),type:"column",token:jt(e)}))))})),c}))),[]}}class on{constructor(e,t){this.declarationNode=e,this.env=t,this.project={enums:[],refs:[],tableGroups:[],tables:[],tablePartials:[]}}interpret(){return this.env.project.set(this.declarationNode,this.project),this.project.token=jt(this.declarationNode),[...this.interpretName(this.declarationNode.name),...this.interpretBody(this.declarationNode.body)]}interpretName(e){if(!e)return this.project.name=null,[];const{name:t}=qt(e);return this.project.name=t,[]}interpretBody(e){return e.body.flatMap((e=>{var t;const n=e;switch(null==(t=n.type)?void 0:t.value.toLowerCase()){case"table":{const e=new en(n,this.env).interpret();return this.project.tables.push(this.env.tables.get(n)),e}case"ref":{const e=new nn(n,this.env).interpret();return this.project.refs.push(this.env.ref.get(n)),e}case"tablegroup":{const e=new sn(n,this.env).interpret();return this.project.tableGroups.push(this.env.tableGroups.get(n)),e}case"enum":{const e=new an(n,this.env).interpret();return this.project.enums.push(this.env.enums.get(n)),e}case"note":return this.project.note={value:et(n.body instanceof w?n.body.body[0].callee:n.body.callee).map(Qt).unwrap(),token:jt(n)},[];case"tablepartial":{const e=new rn(n,this.env).interpret();return this.project.tablePartials.push(this.env.tablePartials.get(n)),e}default:return this.project[n.type.value.toLowerCase()]=et(n.body.callee).unwrap(),[]}}))}}class ln{constructor(e){this.ast=e,this.env={schema:[],tables:new Map,notes:new Map,refIds:{},ref:new Map,enums:new Map,tableGroups:new Map,groupOfTable:{},aliases:[],project:new Map,tablePartials:new Map}}interpret(){const e=this.ast.body.flatMap((e=>{switch(We(e).unwrap_or(void 0)){case $e.Table:return new en(e,this.env).interpret();case $e.Note:return new tn(e,this.env).interpret();case $e.Ref:return new nn(e,this.env).interpret();case $e.TableGroup:return new sn(e,this.env).interpret();case $e.TablePartial:return new rn(e,this.env).interpret();case $e.Enum:return new an(e,this.env).interpret();case $e.Project:return new on(e,this.env).interpret();default:return[]}}));return new ve(function(e){return{schemas:[],tables:Array.from(e.tables.values()),notes:Array.from(e.notes.values()),refs:Array.from(e.ref.values()),enums:Array.from(e.enums.values()),tableGroups:Array.from(e.tableGroups.values()),aliases:e.aliases,project:Array.from(e.project.values())[0]||{},tablePartials:Array.from(e.tablePartials.values())}}(this.env),e)}}var cn=(e=>(e[e.Function=1]="Function",e[e.Constructor=2]="Constructor",e[e.Field=3]="Field",e[e.Variable=4]="Variable",e[e.Class=5]="Class",e[e.Struct=6]="Struct",e[e.Interface=7]="Interface",e[e.Module=8]="Module",e[e.Property=9]="Property",e[e.Event=10]="Event",e[e.Operator=11]="Operator",e[e.Unit=12]="Unit",e[e.Value=13]="Value",e[e.Constant=14]="Constant",e[e.Enum=15]="Enum",e[e.EnumMember=16]="EnumMember",e[e.Keyword=17]="Keyword",e[e.Text=18]="Text",e[e.Color=19]="Color",e[e.File=20]="File",e[e.Reference=21]="Reference",e[e.Customcolor=22]="Customcolor",e[e.Folder=23]="Folder",e[e.TypeParameter=24]="TypeParameter",e[e.User=25]="User",e[e.Issue=26]="Issue",e[e.Snippet=27]="Snippet",e))(cn||{}),un=(e=>(e[e.None=0]="None",e[e.KeepWhitespace=1]="KeepWhitespace",e[e.InsertAsSnippet=4]="InsertAsSnippet",e))(un||{});function hn(e){switch(e){case G.Schema:return cn.Module;case G.Table:case G.TablePartial:return cn.Class;case G.Column:case G.TableGroupField:return cn.Field;case G.Enum:return cn.Enum;case G.EnumField:return cn.EnumMember;case G.TableGroup:return cn.Struct;default:return cn.Text}}function dn(e,t){if(!e||d(e))return!1;for(const n of e.trailingTrivia){if(n.start>t)break;if(n.kind===a.NEWLINE&&n.end<=t)return!1}return!0}function pn(e){return{...e,suggestions:e.suggestions.map((e=>({...e,insertText:` ${e.insertText}`})))}}function En(e){return{...e,suggestions:e.suggestions.map((e=>({...e,insertText:e.insertText.split("").every(he)?e.insertText:`"${e.insertText}"`})))}}function Nn(e,t){return e.getOffsetAt(t)}class fn{constructor(e,t=[]){this.compiler=e,this.triggerCharacters=t}provideCompletionItems(e,t){var n,i;const s=Nn(e,t),r=this.compiler.token.flatStream(),{token:o,index:l}=this.compiler.container.token(s),c=void 0===l?r[0]:r[l+1];if([...(null==o?void 0:o.trailingTrivia)||[],...(null==o?void 0:o.leadingTrivia)||[],...(null==c?void 0:c.leadingTrivia)||[]].find((e=>function(e){return[a.SINGLE_LINE_COMMENT,a.MULTILINE_COMMENT].includes(e.kind)}(e)&&fe(s,e))))return{suggestions:[]};if(void 0===l)return yn();if([a.STRING_LITERAL,a.QUOTED_STRING].includes(o.kind)&&fe(s,o))return{suggestions:[]};const u=this.compiler.container.element(s);if(this.compiler.container.scopeKind(s)===Dn.TOPLEVEL||u instanceof b&&u.type&&u.type.start<=s&&u.type.end>=s)return yn();const h=[...this.compiler.container.stack(s)].reverse();for(const e of h)if(e instanceof L)switch(null==(n=e.op)?void 0:n.value){case">":case"<":case"<>":case"-":return Tn(this.compiler,s,e)}else if(e instanceof _)switch(null==(i=e.op)?void 0:i.value){case">":case"<":case"<>":case"-":return Tn(this.compiler,s,e);case".":return _n(this.compiler,s,e)}else{if(e instanceof v)return vn(this.compiler,s,e);if(e instanceof k)return vn(this.compiler,s,e);if(e instanceof S)return In(this.compiler,s);if(e instanceof C)return mn(this.compiler,s);if(e instanceof g)return An(this.compiler,s,e);if(e instanceof b&&(e.bodyColon&&s>=e.bodyColon.end||e.body&&fe(s,e.body)))return An(this.compiler,s,void 0)}return{suggestions:[]}}}function mn(e,t){const n=e.container.element(t);return bn(e,t,n,[G.TablePartial])}function Tn(e,t,n){const i=e.container.scopeKind(t);if([Dn.REF,Dn.TABLE,Dn.TABLEPARTIAL].includes(i)){const i=bn(e,t,e.container.element(t),[G.Table,G.Schema,G.Column]);return dn(n.op,t)?pn(i):i}return{suggestions:[]}}function bn(e,t,n,i){var s;if(void 0===n)return{suggestions:[]};let a=n;const r={suggestions:[]};for(;a;){if(null!=(s=null==a?void 0:a.symbol)&&s.symbolTable){const{symbol:t}=a;r.suggestions.push(...e.symbol.members(t).filter((({kind:e})=>i.includes(e))).map((({name:e,kind:t})=>({label:e,insertText:e,insertTextRules:un.KeepWhitespace,kind:hn(t),sortText:hn(t).toString().padStart(2,"0"),range:void 0}))))}a=a instanceof b?a.parent:void 0}return En(r)}function In(e,t){var n;switch(e.container.scopeKind(t)){case Dn.INDEXES:return wn(e,t);case Dn.REF:{const i=[...e.container.stack(t)];for(;i.length>0;){const s=i.pop();if(s instanceof _&&"."===(null==(n=s.op)?void 0:n.value))return _n(e,t,s)}}return gn(e,t)}return{suggestions:[]}}function vn(e,t,n){const{token:i}=e.container.token(t);if([a.COMMA,a.LBRACKET].includes(null==i?void 0:i.kind)){const n=Ln(e,t);return(null==i?void 0:i.kind)===a.COMMA&&dn(i,t)?pn(n):n}if(n.name&&n.name.start<=t&&n.name.end>=t)return Ln(e,t);if(n.name instanceof I){const e=function(e,t,n){switch(null==n?void 0:n.toLowerCase()){case"update":case"delete":return{suggestions:["cascade","set default","set null","restrict"].map((e=>({label:e,insertText:e,kind:cn.Value,insertTextRules:un.KeepWhitespace,range:void 0})))};case"type":return{suggestions:["btree","hash"].map((e=>({label:e,insertText:`${e}`,kind:cn.Value,insertTextRules:un.KeepWhitespace,range:void 0})))}}return{suggestions:[]}}(0,0,De(n.name).unwrap_or(""));return(null==i?void 0:i.kind)===a.COLON&&dn(i,t)?pn(e):e}return{suggestions:[]}}function Ln(e,t){const n=e.container.element(t);if(n instanceof T)return{suggestions:[]};const i=e.container.scopeKind(t);if(n.body&&!fe(t,n.body)){let e;switch(i){case Dn.TABLE:case Dn.TABLEPARTIAL:e=[je.HeaderColor,je.Note];break;case Dn.TABLEGROUP:e=[je.Color,je.Note];break;default:e=[]}return{suggestions:e.map((e=>({label:e,insertText:`${e}: `,kind:cn.Field,insertTextRules:un.KeepWhitespace,range:void 0})))}}switch(i){case Dn.TABLE:case Dn.TABLEPARTIAL:return{suggestions:[...[je.PK,je.PKey,je.Null,je.NotNull,je.Increment,je.Unique].map((e=>({label:e,insertText:e,kind:cn.Property,insertTextRules:un.KeepWhitespace,range:void 0}))),...[je.Ref,je.Default,je.Note].map((e=>({label:e,insertText:`${e}: `,kind:cn.Property,insertTextRules:un.KeepWhitespace,range:void 0})))]};case Dn.ENUM:return{suggestions:[...[je.Note].map((e=>({label:e,insertText:`${e}: `,kind:cn.Property,insertTextRules:un.KeepWhitespace,range:void 0})))]};case Dn.INDEXES:return{suggestions:[...[je.Unique,je.PK].map((e=>({label:e,insertText:e,insertTextRules:un.KeepWhitespace,kind:cn.Property,range:void 0}))),...[je.Note,je.Name,je.Type].map((e=>({label:e,insertText:`${e}: `,kind:cn.Property,insertTextRules:un.KeepWhitespace,range:void 0})))]};case Dn.REF:return{suggestions:[je.Update,je.Delete,je.Color].map((e=>({label:e,insertText:`${e}: `,kind:cn.Property,insertTextRules:un.KeepWhitespace,range:void 0})))}}return{suggestions:[]}}function _n(e,t,n){const i=qe(n).unwrap_or([]);if(i.pop(),i.some((e=>!ke(e))))return{suggestions:[]};const s=i.map((e=>ze(e).unwrap()));return En({suggestions:e.symbol.ofName({nameStack:s,owner:e.container.element(t)}).flatMap((({symbol:t})=>e.symbol.members(t))).map((({kind:e,name:t})=>({label:t,insertText:t,kind:hn(e),range:void 0})))})}function An(e,t,n){var i;switch(e.container.scopeKind(t)){case Dn.TABLE:case Dn.TABLEPARTIAL:return function(e,t,n){const i=["Note","indexes"];if(null==n||!n.callee)return{suggestions:i.map((e=>({label:e,insertText:e,insertTextRules:un.KeepWhitespace,kind:cn.Keyword,range:void 0})))};const s=Cn(t,n);return 0===s?{suggestions:i.map((e=>({label:e,insertText:e,insertTextRules:un.KeepWhitespace,kind:cn.Keyword,range:void 0})))}:1===s?function(e,t){return{suggestions:[...["integer","int","tinyint","smallint","mediumint","bigint","bit","bool","binary","varbinary","logical","char","nchar","varchar","varchar2","nvarchar","nvarchar2","binary_float","binary_double","float","double","decimal","dec","real","money","smallmoney","enum","tinyblob","tinytext","blob","text","mediumblob","mediumtext","longblob","longtext","ntext","set","inet6","uuid","image","date","time","datetime","datetime2","timestamp","year","smalldatetime","datetimeoffset","XML","sql_variant","uniqueidentifier","CURSOR","BFILE","CLOB","NCLOB","RAW"].map((e=>({label:e,insertText:e,insertTextRules:un.KeepWhitespace,kind:cn.TypeParameter,sortText:cn.TypeParameter.toString().padStart(2,"0"),range:void 0}))),...bn(e,0,e.container.element(t),[G.Enum,G.Schema]).suggestions]}}(e,t):{suggestions:[]}}(e,t,n);case Dn.PROJECT:return function(e,t,n){const i=["Table","TableGroup","Enum","Note","Ref","TablePartial"];return null!=n&&n.callee?0===Cn(t,n)?{suggestions:i.map((e=>({label:e,insertText:e,insertTextRules:un.KeepWhitespace,kind:cn.Keyword,range:void 0})))}:{suggestions:[]}:{suggestions:i.map((e=>({label:e,insertText:e,insertTextRules:un.KeepWhitespace,kind:cn.Keyword,range:void 0})))}}(0,t,n);case Dn.INDEXES:return function(e,t){return wn(e,t)}(e,t);case Dn.ENUM:return function(e,t,n){return null!=n&&n.callee&&1===Cn(t,n)?bn(e,0,e.container.element(t),[G.Schema,G.Table,G.Column]):{suggestions:[]}}(e,t,n);case Dn.REF:{const n=gn(e,t);return(null==(i=e.container.token(t).token)?void 0:i.kind)===a.COLON&&dn(e.container.token(t).token,t)?pn(n):n}case Dn.TABLEGROUP:return function(e){return{suggestions:[...En({suggestions:[...e.parse.publicSymbolTable().entries()].flatMap((([e])=>{const t=J(e).unwrap_or(void 0);if(void 0===t)return[];const{kind:n,name:i}=t;return n!==G.Table&&n!==G.Schema?[]:{label:i,insertText:i,insertTextRules:un.KeepWhitespace,kind:hn(n),range:void 0}}))}).suggestions,...["Note"].map((e=>({label:e,insertText:e,insertTextRules:un.KeepWhitespace,kind:cn.Keyword,range:void 0})))]}}(e);default:return{suggestions:[]}}}function yn(){return{suggestions:["Table","TableGroup","Enum","Project","Ref","TablePartial"].map((e=>({label:e,insertText:e,insertTextRules:un.KeepWhitespace,kind:cn.Keyword,range:void 0})))}}function gn(e,t){return bn(e,0,e.container.element(t),[G.Schema,G.Table,G.Column])}function wn(e,t){const n=e.container.element(t),i=null==n?void 0:n.parent;if(!((null==i?void 0:i.symbol)instanceof ie))return{suggestions:[]};const{symbolTable:s}=i.symbol;return En({suggestions:[...s.entries()].flatMap((([e])=>{const t=J(e).unwrap_or(void 0);if(void 0===t)return[];const{name:n}=t;return{label:n,insertText:n,insertTextRules:un.KeepWhitespace,kind:hn(G.Column),range:void 0}}))})}function Cn(e,t){if(!t.callee)return-1;const n=[t.callee,...t.args],i=n.findIndex((t=>e<=t.end));return-1===i?n.length:i}class kn{constructor(e){this.compiler=e}provideDefinition(e,t){var n,i;const{uri:s}=e,a=Nn(e,t),r=[...this.compiler.container.stack(a)];for(;0!==r.length;){const e=r.pop();if(null==e||!e.referee)continue;let t;if(null!=(n=e.referee)&&n.declaration&&[m.PRIMARY_EXPRESSION,m.VARIABLE,m.PARTIAL_INJECTION].includes(null==e?void 0:e.kind)?({declaration:t}=e.referee):null!=(i=e.referee)&&i.injectorDeclaration&&(t=e.referee.injectorDeclaration),t){const{startPos:e,endPos:n}=t;return[{range:{startColumn:e.column+1,startLineNumber:e.line+1,endColumn:n.column+1,endLineNumber:n.line+1},uri:s}]}}return[]}}class Sn{constructor(e){this.compiler=e}provideReferences(e,t){const{uri:n}=e,i=Nn(e,t),s=[...this.compiler.container.stack(i)];for(;0!==s.length;){const e=s.pop();if(e&&[m.ELEMENT_DECLARATION,m.FUNCTION_APPLICATION,m.PRIMARY_EXPRESSION].includes(null==e?void 0:e.kind)){const{symbol:t}=e;if(null!=t&&t.references.length)return t.references.map((({startPos:e,endPos:t})=>({range:{startColumn:e.column+1,startLineNumber:e.line+1,endColumn:t.column+1,endLineNumber:t.line+1},uri:n})))}}return[]}}const Pn=Object.freeze(Object.defineProperty({__proto__:null,CompletionItemInsertTextRule:un,CompletionItemKind:cn,DBMLCompletionItemProvider:fn,DBMLDefinitionProvider:kn,DBMLReferencesProvider:Sn},Symbol.toStringTag,{value:"Module"}));var Dn=(e=>(e[e.TABLE=0]="TABLE",e[e.ENUM=1]="ENUM",e[e.TABLEGROUP=2]="TABLEGROUP",e[e.INDEXES=3]="INDEXES",e[e.NOTE=4]="NOTE",e[e.REF=5]="REF",e[e.PROJECT=6]="PROJECT",e[e.CUSTOM=7]="CUSTOM",e[e.TOPLEVEL=8]="TOPLEVEL",e[e.TABLEPARTIAL=9]="TABLEPARTIAL",e))(Dn||{});t.Compiler=class{constructor(){this.source="",this.cache=new Array(16).fill(null),this.nodeIdGenerator=new N,this.symbolIdGenerator=new Z,this.token={invalidStream:this.createQuery(6,(()=>this.parse.tokens().filter(Ae))),flatStream:this.createQuery(7,(()=>this.parse.tokens().flatMap((e=>[...e.leadingInvalid,e,...e.trailingInvalid]))))},this.parse={source:()=>this.source,_:this.createQuery(0,(()=>{const e=new Oe(this.source).lex().chain((e=>new Fe(e,this.nodeIdGenerator).parse())).chain((({ast:e,tokens:t})=>new Xt(e,this.symbolIdGenerator).analyze().map((()=>({ast:e,tokens:t})))));return e.getErrors().length>0?e:e.chain((({ast:e,tokens:t})=>new ln(e).interpret().map((n=>({ast:e,tokens:t,rawDb:n})))))})),ast:this.createQuery(1,(()=>this.parse._().getValue().ast)),errors:this.createQuery(2,(()=>this.parse._().getErrors())),tokens:this.createQuery(4,(()=>this.parse._().getValue().tokens)),rawDb:this.createQuery(3,(()=>this.parse._().getValue().rawDb)),publicSymbolTable:this.createQuery(5,(()=>this.parse._().getValue().ast.symbol.symbolTable))},this.container={stack:this.createQuery(10,(e=>{const t=this.token.flatStream(),{index:n,token:s}=this.container.token(e),r=void 0===n?-1:i.findLastIndex(t,(e=>!e.isInvalid),n);if(-1===r)return[this.parse.ast()];const o=t[r].start;let l=this.parse.ast();const u=[l];for(;;){const e=ge(l).find((e=>fe(o,e)));if(void 0===e||e instanceof c)break;u.push(e),l=e}if((null==s?void 0:s.kind)===a.COLON)return u;for(;u.length>0;){let t=!1;const n=i.last(u);if(n instanceof g){const i=this.parse.source();for(let s=n.end;s<e;s+=1)"\n"===i[s]&&(u.pop(),t=!0)}else n instanceof L||n instanceof _?this.container.token(e).token!==n.op&&(u.pop(),t=!0):n instanceof k?n.listCloseBracket&&n.end<=e&&(u.pop(),t=!0):n instanceof S?n.tupleCloseParen&&n.end<=e&&(u.pop(),t=!0):n instanceof w?n.blockCloseBrace&&n.end<=e&&(u.pop(),t=!0):n instanceof I||n.end<e&&(u.pop(),t=!0);if(t){const t=i.last(u);t instanceof b&&t.end<=e&&u.pop()}if(!t)break}return u})),token:this.createQuery(11,(e=>{const t=this.token.flatStream().findIndex((t=>t.start>=e));return void 0===t||t<=0?{token:void 0,index:void 0}:{token:this.token.flatStream()[t-1],index:t-1}})),element:this.createQuery(12,(e=>{const t=this.container.stack(e);for(let e=t.length-1;e>=0;e-=1)if(t[e]instanceof b)return t[e];return this.parse.ast()})),scope:this.createQuery(14,(e=>{var t,n;return null==(n=null==(t=this.container.element(e))?void 0:t.symbol)?void 0:n.symbolTable})),scopeKind:this.createQuery(15,(e=>{var t;if(this.container.element(e)instanceof T)return 8;switch(null==(t=this.container.element(e).type)?void 0:t.value.toLowerCase()){case"table":return 0;case"enum":return 1;case"ref":return 5;case"tablegroup":return 2;case"indexes":return 3;case"note":return 4;case"project":return 6;case"tablepartial":return 9;default:return 7}}))},this.symbol={ofName:this.createQuery(8,(({nameStack:e,owner:t=this.parse.ast()})=>{var n;if(0===e.length)return[];const i=[];for(let s=t;s;s=s instanceof b?s.parent:void 0){if(null==(n=s.symbol)||!n.symbolTable)continue;const{symbolTable:t}=s.symbol;let a=[t],r=[];for(const t of e)r=a.flatMap((e=>ue(t).flatMap((t=>{const n=e.get(t),i=J(t).unwrap_or(void 0);return n&&i?{...i,symbol:n}:[]})))),a=r.flatMap((e=>e.symbol.symbolTable?e.symbol.symbolTable:[]));i.push(...r)}return i}),(({nameStack:e,owner:t})=>`${e.join(".")}@${t.id}`)),members:this.createQuery(9,(e=>e.symbolTable?[...e.symbolTable.entries()].map((([e,t])=>({...J(e).unwrap(),symbol:t}))):[]))}}createQuery(e,t,n){return i=>{const s=this.cache[e],a=i&&n?n(i):i;if(null!==s){if(!(s instanceof Map))return s;if(s.has(a))return s.get(a)}const r=t(i);return void 0!==i?s instanceof Map?s.set(a,r):(this.cache[e]=new Map,this.cache[e].set(a,r)):this.cache[e]=r,r}}setSource(e){this.source=e,this.cache=new Array(16).fill(null),this.nodeIdGenerator.reset(),this.symbolIdGenerator.reset()}initMonacoServices(){return{definitionProvider:new kn(this),referenceProvider:new Sn(this),autocompletionProvider:new fn(this)}}},t.serialize=function(e,t=!1){return JSON.stringify(e,(function(e,t){var n;return this instanceof T||"symbol"!==e?"symbol"===e?{symbolTable:null==t?void 0:t.symbolTable,id:null==t?void 0:t.id,references:null==t?void 0:t.references.map((e=>e.id)),declaration:null==(n=null==t?void 0:t.declaration)?void 0:n.id}:"referee"===e||"parent"===e||"declaration"===e?null==t?void 0:t.id:"symbolTable"===e?Object.fromEntries(t.table):t:null==t?void 0:t.id}),t?2:0)},t.services=Pn}}]);
